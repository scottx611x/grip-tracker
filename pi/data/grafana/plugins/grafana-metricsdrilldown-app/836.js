"use strict";(self.webpackChunkgrafana_metricsdrilldown_app=self.webpackChunkgrafana_metricsdrilldown_app||[]).push([[619,836],{28:(e,t,r)=>{r.d(t,{Y:()=>s});var n,a,i,o=r(7781);class s extends o.BusEventWithPayload{}i="filters-changed",(a="type")in(n=s)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i},384:(e,t,r)=>{function n(e){return null!==e&&"adhoc"===(null==e?void 0:e.state.type)}function a(e){return null!==e&&"custom"===(null==e?void 0:e.state.type)}function i(e){return null!==e&&"query"===(null==e?void 0:e.state.type)}r.d(t,{BE:()=>n,UG:()=>a,bA:()=>i})},619:(e,t,r)=>{r.r(t),r.d(t,{sortSeries:()=>h,wasmSupported:()=>f});var n=r(6944),a=r(7781),i=r(3241),o=r(3616),s=r(4964),l=r(3347);function c(e){var t;const r=null===(t=e.fields[1])||void 0===t?void 0:t.labels;if(!r)return null;const n=Object.keys(r);return 0===n.length?null:r[n[0]]}const u=(e,t="asc")=>{const r="asc"===t?(e,t)=>(0,s._)(e,t):(e,t)=>(0,s._)(t,e);return e.sort((e,t)=>{const n=c(e);if(!n)return 0;const a=c(t);return a?r(n,a):0})},d=(e,t,r="asc")=>{const n=a.fieldReducers.get(t),i=e.map(e=>{var r,i;var o;return{value:null!==(o=(null!==(i=null===(r=n.reduce)||void 0===r?void 0:r.call(n,e.fields[1],!0,!0))&&void 0!==i?i:(0,a.doStandardCalcs)(e.fields[1],!0,!0))[t])&&void 0!==o?o:0,dataFrame:e}});return i.sort("asc"===r?(e,t)=>e.value-t.value:(e,t)=>t.value-e.value),i.map(({dataFrame:e})=>e)},p=e=>{const t=(0,a.outerJoinDataFrames)({frames:e});if(!t)throw new Error("Error while joining frames into a single one");const r=t.fields.filter(e=>e.type===a.FieldType.number).map(e=>new Float64Array(e.values));return n.OutlierDetector.dbscan({sensitivity:.9}).detect(r)},m=(e,t)=>e.seriesResults[t].isOutlier?-e.seriesResults[t].outlierIntervals.length:0,h=(0,i.memoize)((e,t,r="asc")=>{if(!e.length)return[];const n=[...e];if("alphabetical"===t)return u(n,"asc");if("alphabetical-reversed"===t)return u(n,"desc");if("outliers"===t)try{return((e,t="asc")=>{if(!f())throw new Error("WASM not supported");const r=p(e),n=e.map((e,t)=>({value:m(r,t),dataFrame:e}));return n.sort("asc"===t?(e,t)=>e.value-t.value:(e,t)=>t.value-e.value),n.map(({dataFrame:e})=>e)})(n,r)}catch(e){const t=`Error while sorting by outlying series: "${e.toString()}"!`;return(0,o.HA)([t,"Falling back to standard deviation to identify the most variable series."]),d(n,a.ReducerID.stdDev,r)}return d(n,t,r)},(e,t,r="asc")=>{const n=b(e)?e[0].fields[0].values[0]:0,a=b(e)?e[e.length-1].fields[0].values[e[e.length-1].fields[0].values.length-1]:0;return`${e.length>0?c(e[0]):""}_${e.length>0?c(e[e.length-1]):""}_${n}_${a}_${e.length}_${t}_${r}`});function b(e){return e.length>0&&e[0].fields.length>0&&e[0].fields[0].values.length>0}const f=()=>{const e="object"==typeof WebAssembly;return e||(0,l.z)("wasm_not_supported",{}),e}},697:(e,t,r)=>{r.d(t,{x:()=>s});var n,a,i,o=r(7781);class s extends o.BusEventWithPayload{}i="metrics-variable-activated",(a="type")in(n=s)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i},1053:(e,t,r)=>{r.d(t,{_:()=>s});var n=r(6089),a=r(2007),i=r(5959),o=r.n(i);function s({title:e,description:t}){const r=(0,a.useStyles2)(l);return o().createElement("h6",{className:r.title},o().createElement("span",null,e),o().createElement(a.Tooltip,{content:t,placement:"top"},o().createElement(a.Icon,{name:"info-circle",size:"sm",className:r.infoIcon})))}function l(e){return{title:(0,n.css)({fontSize:"15px",fontWeight:e.typography.fontWeightLight,borderBottom:`1px solid ${e.colors.border.weak}`,paddingBottom:e.spacing(.5)}),infoIcon:(0,n.css)({marginLeft:e.spacing(1),cursor:"pointer",color:e.colors.text.secondary,position:"relative",top:"-4px"})}}},1199:(e,t,r)=>{r.d(t,{B:()=>a});var n=r(3241);const a=(e,t)=>e.length===t.length&&(0,n.isEqual)(e,t)},1252:(e,t,r)=>{r.d(t,{fD:()=>T,NJ:()=>B,VN:()=>N,yH:()=>$,Rm:()=>M});var n=r(7985),a=r(5959),i=r.n(a),o=r(4964),s=r(8361),l=r(8531),c=r(2445),u=r(9851);function d(e){const t=u.K3.parse(e),r=new Set,n=t.cursor();do{if(n.type.is("VectorSelector")&&n.firstChild()){do{if(n.type.is("Identifier")){const t=e.slice(n.from,n.to);t&&r.add(t)}}while(n.nextSibling());n.parent()}}while(n.next());return Array.from(r)}function p(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}const m={showSuccessAlert:!1,showErrorAlert:!1};function h(){return(e=function*(){try{return function(e){const t={},r=e.filter(e=>(null==e?void 0:e.data.length)>0);for(const e of r){const r=e.data.filter(e=>{var t;return"string"==typeof(null===(t=e.model)||void 0===t?void 0:t.expr)&&"__expr__"!==e.datasourceUid});for(const n of r)try{const e=d(n.model.expr);for(const r of e)t[r]=(t[r]||0)+1}catch(t){c.v.warn(t,{message:`Failed to parse PromQL expression in alert rule ${e.title}`})}}return t}(yield(0,l.getBackendSrv)().get("/api/v1/provisioning/alert-rules",void 0,"grafana-metricsdrilldown-app-alert-rule-metric-usage",m))}catch(e){const t="string"==typeof e?new Error(e):e;return c.v.error(t,{message:"Failed to fetch alerting rules"}),{}}},function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){p(i,n,a,o,s,"next",e)}function s(e){p(i,n,a,o,s,"throw",e)}o(void 0)})})();var e}var b=r(7348),f=r(7476);function g(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function y(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){g(i,n,a,o,s,"next",e)}function s(e){g(i,n,a,o,s,"throw",e)}o(void 0)})}}const v={showSuccessAlert:!1,showErrorAlert:!1},w=new Map,S=(0,b.g)((e,t)=>y(function*(){let r=w.get(e);return r||(r=(0,l.getBackendSrv)().get(`/api/dashboards/uid/${e}`,void 0,`grafana-metricsdrilldown-app-dashboard-metric-usage-${e}`,v).then(({dashboard:e})=>e).catch(r=>(t<=5&&c.v.error(r,{dashboardUid:e}),t++,Promise.resolve(null))).finally(()=>{w.delete(e)}),w.set(e,r)),r})(),{concurrency:50});function O(){return y(function*(){try{const e=yield(0,l.getBackendSrv)().get("/api/search",{type:"dash-db",limit:500},"grafana-metricsdrilldown-app-dashboard-search",v);let t=0;return yield Promise.all(e.map(({uid:e})=>S(e,t))).then(E)}catch(e){const t="string"==typeof e?new Error(e):e;return c.v.error(t,{message:"Failed to fetch dashboard metrics"}),{}}})()}function E(e){const t={},r=e.filter(e=>{var t;return e&&(null==e||null===(t=e.panels)||void 0===t?void 0:t.length)});for(const e of r){const r=e.panels.filter(e=>{var t;return(0,f.aQ)(e.datasource)&&"targets"in e&&(null===(t=e.targets)||void 0===t?void 0:t.length)});for(const e of r)for(const r of e.targets){const e=d("string"==typeof r.expr?r.expr:"");for(const r of e)t[r]=(t[r]||0)+1}}return t}class k{getUsageMetrics(e){return this._usageState[e].metrics&&Object.keys(this._usageState[e].metrics).length>0?Promise.resolve(this._usageState[e].metrics):(this._usageState[e].metricsPromise||(this._usageState[e].metricsPromise=this._usageState[e].fetcher().then(t=>(this._usageState[e].metrics=t,this._usageState[e].metricsPromise=void 0,t))),this._usageState[e].metricsPromise)}getUsageForMetric(e,t){return this.getUsageMetrics(t).then(t=>{var r;return null!==(r=t[e])&&void 0!==r?r:0})}constructor(){var e,t,r;r={"dashboard-usage":{metrics:{},metricsPromise:void 0,fetcher:O},"alerting-usage":{metrics:{},metricsPromise:void 0,fetcher:h}},(t="_usageState")in(e=this)?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}}function x(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function P(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){x(e,t,r[t])})}return e}function j(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const C="metrics-drilldown-recent-metrics/v1",_=6,L=30;function N(e){try{const t=D(),r=Date.now(),n=t.filter(t=>t.name!==e);n.unshift({name:e,timestamp:r});const a=n.slice(0,_);localStorage.setItem(C,JSON.stringify(a))}catch(t){const r=t instanceof Error?t:new Error(String(t));c.v.error(r,j(P({},r.cause||{}),{metricName:e}))}}function D(){try{const e=localStorage.getItem(C);if(!e)return[];const t=JSON.parse(e),r=Date.now()-24*L*60*60*1e3,n=t.filter(e=>e.timestamp>r);return n.length!==t.length&&localStorage.setItem(C,JSON.stringify(n)),n}catch(e){return c.v.error(e,{message:"Failed to get recent metrics:"}),[]}}const A=[{label:"Default",value:"default"},{label:"Dashboard Usage",value:"dashboard-usage"},{label:"Alerting Usage",value:"alerting-usage"}],B="metrics-reducer-sort-by";class T extends n.Bs{activationHandler(){const e=n.jh.getVariables(this).getByName(B);this.supportedSortByOptions.has(e.getValue())||e.changeValueTo("default"),this._subs.add(e.subscribeToState((e,t)=>{e.value!==t.value&&this.publishEvent(new s.S({sortBy:e.value}),!0)}))}getUsageForMetric(e,t){return this.usageFetcher.getUsageForMetric(e,t)}getUsageMetrics(e){return this.usageFetcher.getUsageMetrics(e)}constructor(e){super(j(P({},e),{key:"metrics-sorter",$variables:new n.Pj({variables:[new n.yP({name:B,label:"Sort by",value:"default",query:A.map(e=>`${e.label} : ${e.value}`).join(","),description:"Sort metrics by default (alphabetically, with recently-selected metrics first), by prevalence in dashboard panel queries, or by prevalence in alerting rules"})]}),inputControls:new n.K8({layout:"horizontal"})})),x(this,"initialized",!1),x(this,"supportedSortByOptions",new Set(["default","dashboard-usage","alerting-usage"])),x(this,"usageFetcher",new k),this.addActivationHandler(()=>this.activationHandler())}}function $(e,t){return[...e].sort((e,r)=>{const n=t[e]||0,a=t[r]||0;return a!==n?a-n:(0,o._)(e,r)})}function M(e){const t=D().map(e=>e.name),r=new Set(t),[n,a]=e.reduce(([e,t],n)=>(r.has(n)?e.push(n):t.push(n),[e,t]),[[],[]]),i=function(e){return[...e].sort((e,t)=>(0,o._)(e,t))}(a);return[...t.filter(e=>n.includes(e)),...i]}x(T,"Component",({model:e})=>{const{inputControls:t}=e.useState();return i().createElement("div",{"data-testid":"sort-by-select"},i().createElement(t.Component,{model:t}))})},1464:(e,t,r)=>{r.d(t,{I:()=>o});var n=r(697),a=r(6920),i=r(7397);function o(e){const t=e.state.key;if(!t)throw new TypeError(`Variable "${e.state.name}" has no key. Please provide a key in order to publish its lifecycle events.`);return e.addActivationHandler(()=>(e.publishEvent(new n.x({key:t}),!0),!e.state.loading&&e.state.options.length&&e.publishEvent(new i.x({key:t,options:e.state.options}),!0),e.subscribeToState((r,n)=>{!r.loading&&n.loading&&e.publishEvent(new i.x({key:t,options:r.options}),!0)}),()=>{e.publishEvent(new a.e({key:t}),!0)})),e}},1522:(e,t,r)=>{r.d(t,{n:()=>o});var n=r(5959),a=r(2445);function i(e,t){return e instanceof Error?e:"string"==typeof e?new Error(e):"string"==typeof e.message?new Error(e.message):new Error(t)}function o(){const[e,t]=(0,n.useState)();return(0,n.useEffect)(()=>{const e=e=>{(function(e){var t,r,n,i;if(e.filename&&new URL(e.filename).protocol.endsWith("extension:"))return a.v.error(new Error(`Browser extension error: ${e.message}`),{filename:e.filename,lineno:null===(t=e.lineno)||void 0===t?void 0:t.toString(),colno:null===(r=e.colno)||void 0===r?void 0:r.toString()}),!1;return null!==e.error||!e.message||(a.v.error(new Error(`Non-critical error: ${e.message}`),{filename:e.filename,lineno:null===(n=e.lineno)||void 0===n?void 0:n.toString(),colno:null===(i=e.colno)||void 0===i?void 0:i.toString()}),!1)})(e)&&t(i(e.error,"Uncaught exception!"))},r=e=>{"cancelled"!==e.reason.type?t(i(e.reason,"Unhandled rejection!")):t(void 0)};return window.addEventListener("error",e),window.addEventListener("unhandledrejection",r),()=>{window.removeEventListener("unhandledrejection",r),window.removeEventListener("error",e)}},[]),[e,t]}},1709:(e,t,r)=>{r.d(t,{tw:()=>P,Rg:()=>j,iK:()=>x,yG:()=>_});var n=r(6089),a=r(7781),i=r(7985),o=r(2007),s=r(5959),l=r.n(s),c=r(1932),u=r(8162);function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function p(e,t="avg"){return e?"sum":t}function m({metric:e,filters:t,isRateQuery:r,groupings:n,ignoreUsage:a=!1,nonRateQueryFunction:i="avg"}){const o=!(0,c.Rq)(e);let s=new u.r4({metric:o?"":e,values:{},defaultOperator:u.md.equal,defaultSelectors:[...o?[{label:(0,c.Nc)(e),operator:u.md.equal,value:"__REMOVE__"}]:[],...a?[{label:"__ignore_usage__",operator:u.md.equal,value:""}]:[],...t.filter(e=>"__name__"!==e.key).map(({key:e,value:t,operator:r})=>({label:(0,c.Nc)(e),operator:r,value:t}))]}).toString();return o&&(s=s.replace('="__REMOVE__"',"")),r&&(s=u.GH.rate({expr:s,interval:"$__rate_interval"})),u.GH[p(r,i)](function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){d(e,t,r[t])})}return e}({expr:s},(null==n?void 0:n.length)?{by:n}:{}))}var h=r(7437),b=r(2127),f=r(8534),g=r(5938);var y=r(6145),v=r(1625);const w=[{type:y.dM.ValueToText,options:{0:{color:"red",text:"down"},1:{color:"green",text:"up"}}}];var S=r(519);function O(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function E(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){O(e,t,r[t])})}return e}function k(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const x="260px",P="220px",j="160px",C=new Set(["count","total","sum","bucket"]);class _ extends i.Bs{onActivate(){const{body:e,prometheusFunction:t}=this.state;this._subs.add(e.state.$data.subscribeToState(r=>{var n;if((null===(n=r.data)||void 0===n?void 0:n.state)!==a.LoadingState.Done)return;const{series:i}=r.data;(null==i?void 0:i.length)&&e.setState({fieldConfig:{defaults:e.state.fieldConfig.defaults,overrides:[{matcher:{id:a.FieldMatcherID.byFrameRefID,options:i[0].refId},properties:[{id:"displayName",value:t}]}]}})}))}static buildVizPanel({metricName:e,title:t,highlight:r,color:n,hideLegend:a,prometheusFunction:o,matchers:s,headerActions:l,isNativeHistogram:c=!1}){const u=r?`${t} (current)`:t,d=(0,h.l_)(e),p=e.endsWith("_bucket")||c;return"up"===e||e.endsWith("_up")?function({panelTitle:e,headerActions:t,queryRunner:r}){return r.setState({maxDataPoints:100}),i.d0.statushistory().setTitle(e).setHeaderActions(t.map(e=>e.clone())).setData(r).setColor({mode:"palette-classic"}).setMappings(w).setOption("legend",{showLegend:!0}).setOption("perPage",0).setOption("showValue",v.yL.Never).setDisplayName("status")}({panelTitle:u,headerActions:l,queryRunner:_.buildQueryRunner({metricName:e,matchers:s,prometheusFunction:"min",isHistogram:p})}).setUnit(d).build():p?function({panelTitle:e,queryRunner:t,headerActions:r,hideLegend:n}){return i.d0.heatmap().setTitle(e).setData(t).setOption("calculate",!1).setOption("color",{mode:g.P7.Scheme,exponent:.5,scheme:"Spectral",steps:32,reverse:!1}).setHeaderActions(r.map(e=>e.clone())).setOption("legend",{show:!n})}({panelTitle:u,headerActions:l,hideLegend:a,queryRunner:_.buildQueryRunner({metricName:e,matchers:s,prometheusFunction:"rate",isHistogram:p,queryOptions:{format:"heatmap"}})}).setUnit(d).build():function({panelTitle:e,queryRunner:t,color:r,headerActions:n,hideLegend:a}){return i.d0.timeseries().setTitle(e).setData(t).setColor({mode:"fixed",fixedColor:r}).setCustomFieldConfig("fillOpacity",9).setCustomFieldConfig("pointSize",1).setHeaderActions(n.map(e=>e.clone())).setOption("legend",{showLegend:!a})}({panelTitle:u,headerActions:l,color:n,hideLegend:a,queryRunner:_.buildQueryRunner({metricName:e,matchers:s,prometheusFunction:o,isHistogram:p})}).setUnit(d).build()}static buildQueryRunner({metricName:e,matchers:t,isHistogram:r,prometheusFunction:n,queryOptions:a={}}){const o=t.map(S.q),{isRateQuery:s,groupings:l}=_.determineQueryProperties(e,r),c=m(E({metric:e,filters:o,isRateQuery:s,ignoreUsage:!0,groupings:l},n?{nonRateQueryFunction:n}:{}));return new i.dt({datasource:b.GH,maxDataPoints:_.MAX_DATA_POINTS,queries:[k(E({},a),{refId:e,expr:c,fromExploreMetrics:!0})]})}static determineQueryProperties(e,t){const r=e.split("_").at(-1);let n;return t&&(n=["le"]),{isRateQuery:C.has(r||""),groupings:n}}constructor(e){const{isRateQuery:t}=_.determineQueryProperties(e.metricName,e.isNativeHistogram);var r;const n=k(E({},e),{prometheusFunction:null!==(r=e.prometheusFunction)&&void 0!==r?r:p(t),isNativeHistogram:e.isNativeHistogram,matchers:e.matchers||[],title:e.title||e.metricName,height:e.height||P,hideLegend:Boolean(e.hideLegend),highlight:Boolean(e.highlight),headerActions:[...e.headerActions||[new f.B({metricName:e.metricName})]]});super(k(E({key:`metric-viz-panel-${n.metricName}`},n),{body:_.buildVizPanel(E({},n))})),this.addActivationHandler(this.onActivate.bind(this))}}O(_,"MAX_DATA_POINTS",250),O(_,"Component",({model:e})=>{const{body:t,height:r,highlight:a,isNativeHistogram:i}=e.useState(),s=(0,o.useStyles2)(N,r);return l().createElement("div",{className:(0,n.cx)(s.container,a&&s.highlight,i&&s.nativeHistogram)},t&&l().createElement(t.Component,{model:t}))});const L=e=>(0,n.css)({'[class$="-panel-header"]':{position:"relative",paddingLeft:"120px"},'[class$="-panel-title"]::before':{content:'"Native Histogram"',fontSize:"12px",color:"rgb(158, 193, 247)",position:"absolute",left:"8px",top:"7px",display:"inline-flex",alignItems:"center",justifyContent:"center",width:"116px",height:"22px",padding:0,border:`1px solid ${e.colors.info.text}`,borderRadius:e.shape.radius.pill,background:e.colors.info.transparent,cursor:"auto"}});function N(e,t){return{container:(0,n.css)({height:t}),highlight:(0,n.css)({border:`2px solid ${e.colors.primary.main}`}),nativeHistogram:L(e)}}},1816:(e,t,r)=>{r.d(t,{W:()=>s});var n,a,i,o=r(7781);class s extends o.BusEventWithPayload{}i="quick-search-changed",(a="type")in(n=s)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i},1955:(e,t,r)=>{r.d(t,{b:()=>q});var n,a,i,o=r(6089),s=r(7781),l=r(1932),c=r(8531),u=r(7985),d=r(2007),p=r(5959),m=r.n(p),h=r(2127),b=r(2445),f=r(7476);class g extends u.mI{onActivate(){this.setState({skipUrlSync:!1}),this.subscribeToState((e,t)=>{e.value&&e.value!==t.value&&localStorage.setItem(g.LOCAL_STORAGE_KEY,e.value)})}static getCurrentDataSource(){const e=Object.values(c.config.datasources).filter(e=>(0,f.aQ)(e)),t=new URL(window.location.href).searchParams.get(`var-${h.EY}`),r=localStorage.getItem(g.LOCAL_STORAGE_KEY),n=e.find(e=>e.uid===t)||e.find(e=>e.uid===r)||e.find(e=>e.isDefault)||e[0];return n?n.uid:(b.v.warn("Cannot find any Prometheus data source!"),"no-data-source-configured")}constructor({initialDS:e}){super({key:h.EY,name:h.EY,pluginId:"prometheus",label:"Data source",description:"Only prometheus data sources are supported",skipUrlSync:!e,value:e||g.getCurrentDataSource()}),this.addActivationHandler(this.onActivate.bind(this))}}i="metricsDrilldownDataSource",(a="LOCAL_STORAGE_KEY")in(n=g)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i;const y=(0,p.memo)(function({size:e}){const t=(0,d.useStyles2)(v);return m().createElement("img",{className:(0,o.cx)(t.logo,e),src:"public/plugins/grafana-metricsdrilldown-app/img/logo.svg"})}),v=()=>({logo:o.css`
    &.small {
      width: 24px;
      height: 24px;
      margin-right: 4px;
      position: relative;
      top: -2px;
    }

    &.large {
      width: 40px;
      height: 40px;
    }
  `});const w=r(5176).t,S=`https://github.com/grafana/metrics-drilldown/commit/${w}`,{buildInfo:O}=c.config;function E(){const e=(0,d.useStyles2)(P),{meta:{info:{version:t,updated:r}}}=(0,s.usePluginContext)()||{meta:{info:{version:"?.?.?",updated:"?"}}};return m().createElement("div",{className:e.menuHeader},m().createElement("h5",null,m().createElement(y,{size:"small"}),"Grafana Metrics Drilldown v",t),m().createElement("div",{className:e.subTitle},"Last update: ",r))}function k(){const e="dev"===w,t=e?w:w.slice(0,8);return m().createElement(d.Menu,{header:m().createElement(E,null)},m().createElement(d.Menu.Item,{label:`Commit SHA: ${t}`,icon:"github",onClick:()=>window.open(S),disabled:e}),m().createElement(d.Menu.Item,{label:"Changelog",icon:"list-ul",onClick:()=>window.open("https://github.com/grafana/metrics-drilldown/blob/main/CHANGELOG.md","_blank","noopener,noreferrer")}),m().createElement(d.Menu.Item,{label:"Contribute",icon:"external-link-alt",onClick:()=>window.open("https://github.com/grafana/metrics-drilldown/blob/main/docs/contributing.md","_blank","noopener,noreferrer")}),m().createElement(d.Menu.Item,{label:"Documentation",icon:"document-info",onClick:()=>window.open("https://grafana.com/docs/grafana/latest/explore/simplified-exploration/metrics","_blank","noopener,noreferrer")}),m().createElement(d.Menu.Item,{label:"Report an issue",icon:"bug",onClick:()=>window.open("https://github.com/grafana/metrics-drilldown/issues/new?template=bug_report.md","_blank","noopener,noreferrer")}),m().createElement(d.Menu.Divider,null),m().createElement(d.Menu.Item,{label:`Grafana ${O.edition} v${O.version} (${O.env})`,icon:"grafana",onClick:()=>window.open(`https://github.com/grafana/grafana/commit/${O.commit}`,"_blank","noopener,noreferrer")}))}function x(){return m().createElement(d.Dropdown,{overlay:()=>m().createElement(k,null),placement:"bottom-end"},m().createElement(d.Button,{icon:"info-circle",variant:"secondary",tooltip:"Plugin info",tooltipPlacement:"top",title:"Plugin info","data-testid":"plugin-info-button"}))}const P=e=>({button:o.css`
    position: relative;
    display: flex;
    align-items: center;
    width: 32px;
    height: 32px;
    line-height: 30px;
    border: 1px solid ${e.colors.border.weak};
    border-radius: 2px;
    border-left: 0;
    color: ${e.colors.text.primary};
    background: ${e.colors.background.secondary};

    &:hover {
      border-color: ${e.colors.border.medium};
      background-color: ${e.colors.background.canvas};
    }
  `,menuHeader:o.css`
    padding: ${e.spacing(.5,1)};
    white-space: nowrap;
  `,subTitle:o.css`
    color: ${e.colors.text.secondary};
    font-size: ${e.typography.bodySmall.fontSize};
  `});var j=r(3616),C=r(8499),_=r(3347),L=r(9661),N=r(4796);function D(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class A extends u.Bs{constructor(e){var t,r;super({stickyMainGraph:null===(t=e.stickyMainGraph)||void 0===t||t,isOpen:null!==(r=e.isOpen)&&void 0!==r&&r}),D(this,"onToggleStickyMainGraph",()=>{const e=!this.state.stickyMainGraph;(0,_.z)("settings_changed",{stickyMainGraph:e}),this.setState({stickyMainGraph:e})}),D(this,"onToggleOpen",e=>{this.setState({isOpen:e})})}}function B(e){return{popover:(0,o.css)({display:"flex",padding:e.spacing(2),flexDirection:"column",background:e.colors.background.primary,boxShadow:e.shadows.z3,borderRadius:e.shape.radius.default,border:`1px solid ${e.colors.border.weak}`,zIndex:1,marginRight:e.spacing(2)}),heading:(0,o.css)({fontWeight:e.typography.fontWeightMedium,paddingBottom:e.spacing(2)}),options:(0,o.css)({display:"grid",gridTemplateColumns:"1fr 50px",rowGap:e.spacing(1),columnGap:e.spacing(2)})}}D(A,"Component",({model:e})=>{const{stickyMainGraph:t,isOpen:r}=e.useState(),n=(0,d.useStyles2)(B),a=(0,N.kj)(e),{topScene:i}=a.useState();if(!(i instanceof L.R))return null;return m().createElement(d.Dropdown,{overlay:()=>m().createElement("div",{className:n.popover,onClick:e=>e.stopPropagation()},m().createElement("div",{className:n.heading},"Settings"),i instanceof L.R&&m().createElement("div",{className:n.options},m().createElement("div",null,"Always keep selected metric graph in-view"),m().createElement(d.Switch,{value:t,onChange:e.onToggleStickyMainGraph}))),placement:"bottom",onVisibleChange:e.onToggleOpen},m().createElement(d.ToolbarButton,{icon:"cog",variant:"canvas",isOpen:r,"data-testid":"settings-button"}))});var T=r(5749),$=r(2425),M=r(7265),I=r(7019),R=r(384);function F(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function V(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){F(i,n,a,o,s,"next",e)}function s(e){F(i,n,a,o,s,"throw",e)}o(void 0)})}}function H(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function z(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){H(e,t,r[t])})}return e}function U(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class q extends u.Bs{_onActivate(){this.setState({trailActivated:!0}),this.state.topScene||this.setState({topScene:G(this.state.metric)}),this.subscribeToEvent(h.OO,this._handleMetricSelectedEvent.bind(this));const e=u.jh.lookupVariable(h.Ao,this);(0,R.BE)(e)&&this._subs.add(null==e?void 0:e.subscribeToState((e,t)=>{this._addingFilterWithoutReportingInteraction||(0,_.h)(e.filters,t.filters)}));const t=()=>{const e=u.jh.lookupVariable(h.Ao,this),t=(0,R.BE)(e)&&e.state.filters.length>0;(this.state.metric||t)&&(0,$._r)().setRecentTrail(this)};return window.addEventListener("unload",t),()=>{this.state.embedded||t(),window.removeEventListener("unload",t)}}addFilterWithoutReportingInteraction(e){const t=u.jh.lookupVariable(h.Ao,this);(0,R.BE)(t)&&(this._addingFilterWithoutReportingInteraction=!0,t.setState({filters:[...t.state.filters,e]}),this._addingFilterWithoutReportingInteraction=!1)}getMetricMetadata(e){return this.datasourceHelper.getMetadataForMetric(e)}isNativeHistogram(e){return this.datasourceHelper.isNativeHistogram(e)}initializeHistograms(){return V(function*(){if(!this.state.histogramsLoaded){try{yield this.datasourceHelper.initializeHistograms()}catch(e){(0,j.HA)(["Error while initializing histograms!",e.toString()])}this.setState({nativeHistograms:this.listNativeHistograms(),histogramsLoaded:!0})}}).call(this)}listNativeHistograms(){var e;return null!==(e=this.datasourceHelper.listNativeHistograms())&&void 0!==e?e:[]}resetNativeHistograms(){this.setState({histogramsLoaded:!1,nativeHistograms:[]})}getCurrentMetricMetadata(){return this.getMetricMetadata(this.state.metric)}_handleMetricSelectedEvent(e){return V(function*(){var t;const r=null!==(t=e.payload)&&void 0!==t?t:"";let n=!1;this.isNativeHistogram(r)&&(n=!0),this._urlSync.performBrowserHistoryAction(()=>{this.setState(this.getSceneUpdatesForNewMetricValue(r,n))});const a=u.jh.lookupVariable(h.Ao,this);(0,R.BE)(a)&&a.setState({baseFilters:W(e.payload)})}).call(this)}getSceneUpdatesForNewMetricValue(e,t){const r={};return r.metric=e,r.nativeHistogramMetric=t?"1":"",r.topScene=G(e,t),r}getUrlState(){const{metric:e,metricSearch:t,nativeHistogramMetric:r}=this.state;return{metric:e,metricSearch:t,nativeHistogramMetric:r}}updateFromUrl(e){const t={};if("string"==typeof e.metric){if(this.state.metric!==e.metric){let r=!1;"1"===e.nativeHistogramMetric&&(r=!0),Object.assign(t,this.getSceneUpdatesForNewMetricValue(e.metric,r))}}else null!=e.metric||this.state.embedded||(t.metric=void 0,t.topScene=new C.m);"string"==typeof e.metricSearch?t.metricSearch=e.metricSearch:null==e.metric&&(t.metricSearch=void 0),this.setState(t)}getQueries(){return u.jh.findAllObjects(this,e=>(0,M.xT)(e)).reduce((e,t)=>(e.push(...t.state.queries.map(e=>U(z({},e),{expr:u.jh.interpolate(t,e.expr)}))),e),[])}constructor(e){var t,r,n,a,i,o,c,d,p,m,b,f,y;super(z({$timeRange:null!==(r=e.$timeRange)&&void 0!==r?r:new u.JZ({}),$variables:null!==(n=e.$variables)&&void 0!==n?n:(b=e.initialDS,f=e.metric,y=e.initialFilters,new u.Pj({variables:[new g({initialDS:b}),new u.H9({key:h.Ao,name:h.Ao,label:"Filters",addFilterButtonText:"Add label",datasource:h.GH,hide:s.VariableHide.dontHide,layout:"combobox",filters:null!=y?y:[],baseFilters:W(f),applyMode:"manual",allowCustomValue:!0,expressionBuilder:e=>e.filter(e=>"__name__"!==e.key).map(e=>`${(0,l.Nc)(e.key)}${e.operator}"${e.value}"`).join(",")})]})),controls:null!==(a=e.controls)&&void 0!==a?a:[new u.K8({layout:"vertical"}),new u.N0,new u.KE({}),new u.WM({})],settings:null!==(i=e.settings)&&void 0!==i?i:new A({}),pluginInfo:new u.dM({component:x}),createdAt:null!==(o=e.createdAt)&&void 0!==o?o:(new Date).getTime(),dashboardMetrics:{},alertingMetrics:{},nativeHistograms:null!==(c=e.nativeHistograms)&&void 0!==c?c:[],histogramsLoaded:null!==(d=e.histogramsLoaded)&&void 0!==d&&d,nativeHistogramMetric:null!==(p=e.nativeHistogramMetric)&&void 0!==p?p:"",trailActivated:null!==(m=e.trailActivated)&&void 0!==m&&m},e)),H(t=this,"_urlSync",new u.So(t,{keys:["metric","metricSearch","nativeHistogramMetric"]})),H(t,"_variableDependency",new u.Sh(t,{variableNames:[h.EY],onReferencedVariableValueChanged:e=>V(function*(){const{name:r}=e.state;r===h.EY&&(t.datasourceHelper.reset(),t.resetNativeHistograms())})()})),H(t,"_addingFilterWithoutReportingInteraction",!1),H(t,"datasourceHelper",new T.q(t)),t.addActivationHandler(t._onActivate.bind(t))}}function G(e,t=!1){return e?new L.R({metric:e,nativeHistogram:t}):new C.m}function Q(e,t,r){const n=(0,I.T)(e,r);return{container:(0,o.css)({flexGrow:1,display:"flex",gap:e.spacing(1),flexDirection:"column",padding:e.spacing(1,2),position:"relative",background:n}),body:(0,o.css)({flexGrow:1,display:"flex",flexDirection:"column",minHeight:0}),controls:(0,o.css)({display:"flex",gap:e.spacing(1),padding:e.spacing(1,0),alignItems:"flex-end",flexWrap:"wrap",position:"sticky",background:n,zIndex:e.zIndex.navbarFixed,top:t,borderBottom:`1px solid ${e.colors.border.weak}`}),settingsInfo:(0,o.css)({display:"flex",gap:e.spacing(.5)})}}function W(e){return e?[{key:"__name__",operator:"=",value:e}]:[]}function K(){const e=document.querySelector('[data-testid="app-controls"]');if(!e)return;const{height:t}=e.getBoundingClientRect();document.documentElement.style.setProperty("--app-controls-height",`${t}px`)}H(q,"Component",({model:e})=>{const{controls:t,topScene:r,settings:n,pluginInfo:a,embedded:i}=e.useState();var o;const s=null!==(o=(0,c.useChromeHeaderHeight)())&&void 0!==o?o:0,l=i?0:s,b=(0,d.useStyles2)(Q,l,e);return(0,p.useEffect)(()=>{e.initializeHistograms()},[e]),(0,p.useEffect)(()=>{const t=u.jh.lookupVariable(h.Ao,e),r=e.datasourceHelper;(0,N.FG)(e,t,r)},[e]),(0,p.useEffect)(()=>{K();const e=document.querySelector('[data-testid="app-controls"]');if(!e)return;const t=new ResizeObserver(K);return t.observe(e),()=>{t.disconnect(),document.documentElement.style.removeProperty("--app-controls-height")}},[i,t]),m().createElement("div",{className:b.container},t&&m().createElement("div",{className:b.controls,"data-testid":"app-controls"},t.map(e=>m().createElement(e.Component,{key:e.state.key,model:e})),m().createElement("div",{className:b.settingsInfo},m().createElement(n.Component,{model:n}),m().createElement(a.Component,{model:a}))),r&&m().createElement(u.$L,{scene:r,createBrowserHistorySteps:!0,updateUrlOnInit:!0,namespace:e.state.urlNamespace},m().createElement("div",{className:b.body},r&&m().createElement(r.Component,{model:r}))))})},2024:(e,t,r)=>{r.d(t,{d:()=>o});var n=r(2007),a=r(5959),i=r.n(a);function o({label:e,batchSizes:t,onClick:r,tooltip:a}){return i().createElement(n.Button,{variant:"secondary",fill:"outline",onClick:r,tooltip:a,tooltipPlacement:"top"},"Show ",t.increment," more ",1===t.increment?e:`${e}s`," (",t.current,"/",t.total,")")}},2127:(e,t,r)=>{r.d(t,{Ao:()=>l,Az:()=>f,EY:()=>h,GH:()=>w,H0:()=>C,I1:()=>E,Kf:()=>g,OO:()=>j,QX:()=>s,Rp:()=>d,aZ:()=>m,dc:()=>x,gR:()=>b,hc:()=>y,jT:()=>O,sQ:()=>S,td:()=>v,ui:()=>c,up:()=>k,ym:()=>P,yr:()=>p});var n=r(7781),a=r(7985),i=r(2245);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const s="/explore/metrics",l="filters",c="${filters}",u="metric",d="${metric}",p="groupby",m="${groupby}",h="ds",b="${ds}",f="logsDs",g="${logsDs}",y="other_metric_filters",v="$__logs__",w={uid:b},S="grafana.trails.recent",O="grafana.trails.bookmarks",E="grafana.trails.breakdown.sort",k=250,x=500;function P(e){return[new a.x0({name:u,value:e,hide:i.zL.hideVariable})]}class j extends n.BusEventWithPayload{}o(j,"type","metric-selected-event");class C extends n.BusEventBase{}o(C,"type","refresh-metrics-event")},2425:(e,t,r)=>{r.d(t,{yn:()=>y,_r:()=>w});var n=r(7781),a=r(7985),i=r(3241),o=r(8531),s=r(2007),l=r(5959),c=r.n(l),u=r(4137),d=r(2127),p=r(4796);var m=r(1955);function h(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class b{_loadRecentTrailsFromStorage(){const e=[],t=localStorage.getItem(d.sQ);if(t){const r=JSON.parse(t);for(const t of r){const r=this._deserializeTrail(t);e.push(r.getRef())}}return e}_loadBookmarksFromStorage(){const e=localStorage.getItem(d.jT);return(e?JSON.parse(e):[]).map(e=>{if(null!=(t=e)&&"object"==typeof t&&"history"in t){const t=null!=e.currentStep?e.currentStep:e.history.length-1;return{urlValues:e.history[t].urlValues,createdAt:e.createdAt||Date.now()}}var t;return e})}_deserializeTrail(e){const t=new m.b({}),r="urlValues"in e;return"history"in e?e.history.forEach(e=>{this._loadFromUrl(t,e.urlValues)}):r&&this._loadFromUrl(t,e.urlValues),t.setState(a.Go.cloneSceneObjectState(t.state,{})),t}_serializeTrail(e){return{urlValues:a.Go.getUrlState(e)}}getTrailForBookmarkIndex(e){const t=this._bookmarks[e];return t?this.getTrailForBookmark(t):(0,p.ef)()}getTrailForBookmark(e){const t=y(e);for(const e of this._recent){const r=e.resolve();if(y(r)===t)return r}const r=new m.b({});return this._loadFromUrl(r,e.urlValues),r}_loadFromUrl(e,t){const r=n.urlUtil.renderUrl("",t);a.Go.syncStateFromSearchParams(e,new URLSearchParams(r))}get recent(){return this._recent}get lastModified(){return this._lastModified}load(){this._recent=this._loadRecentTrailsFromStorage(),this._bookmarks=this._loadBookmarksFromStorage(),this._refreshBookmarkIndexMap(),this._lastModified=Date.now()}setRecentTrail(e){if(!e.state.trailActivated)return;this._recent=this._recent.filter(t=>t!==e.getRef());const t=f(e);this._recent=this._recent.filter(e=>{const r=f(e.resolve());return!(0,i.isEqual)(t,r)}),this._recent.unshift(e.getRef()),this._save()}get bookmarks(){return this._bookmarks}addBookmark(e){const t={urlValues:a.Go.getUrlState(e),createdAt:Date.now()};this._bookmarks.unshift(t),this._refreshBookmarkIndexMap(),this._save(),function(){const e=(0,o.getAppEvents)(),t=(0,p.y)(u.bw.Drilldown),r=t?c().createElement("i",null,"the Metrics Reducer sidebar"):c().createElement("i",null,"Drilldown > Metrics");e.publish({type:n.AppEvents.alertSuccess.name,payload:["Bookmark created",c().createElement(s.Stack,{gap:2,direction:"row",key:"bookmark-notification"},c().createElement("div",null,"You can view bookmarks under ",r),!t&&c().createElement(s.LinkButton,{fill:"solid",variant:"secondary",href:d.QX},"View bookmarks"))]})}()}removeBookmark(e){e<this._bookmarks.length&&(this._bookmarks.splice(e,1),this._refreshBookmarkIndexMap(),this._save())}getBookmarkIndex(e){const t=y(e);return this._bookmarkIndexMap.get(t)}_refreshBookmarkIndexMap(){this._bookmarkIndexMap.clear(),this._bookmarks.forEach((e,t)=>{const r=y(e);this._bookmarkIndexMap.set(r,t)})}constructor(){h(this,"_recent",[]),h(this,"_bookmarks",[]),h(this,"_save",void 0),h(this,"_lastModified",void 0),h(this,"_bookmarkIndexMap",new Map),this.load(),this._lastModified=Date.now();const e=()=>{const e=this._recent.slice(0,20).map(e=>this._serializeTrail(e.resolve()));localStorage.setItem(d.sQ,JSON.stringify(e)),localStorage.setItem(d.jT,JSON.stringify(this._bookmarks)),this._lastModified=Date.now()};this._save=(0,i.debounce)(e,1e3),window.addEventListener("beforeunload",()=>{this._save=e})}}function f(e){const t=a.Go.getUrlState(e);return g(t),t}function g(e){var t;(delete e.actionView,delete e.layout,delete e.metricSearch,delete e.refresh,""!==e["var-groupby"]&&void 0!==e["var-groupby"]||(e["var-groupby"]="$__all"),"string"!=typeof e["var-filters"])&&(e["var-filters"]=null===(t=e["var-filters"])||void 0===t?void 0:t.filter(e=>""!==e));return e}function y(e){return e instanceof m.b?JSON.stringify(f(e)):JSON.stringify(g(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){h(e,t,r[t])})}return e}({},e.urlValues)))}let v;function w(){return v||(v=new b),v}},2745:(e,t,r)=>{r.d(t,{J:()=>s,w:()=>l});var n=r(8531),a=r(5959),i=r(4796),o=r(5521);const s=(0,a.createContext)({trail:(0,i.ef)(),goToUrlForTrail:()=>{}});function l(){const[e,t]=(0,a.useState)((0,i.ef)()),r=e=>{n.locationService.push((0,i.xi)(e)),t(e)};return(0,a.useEffect)(()=>{const e=o.C.subscribe(e=>{r(e)});return()=>e()},[]),{trail:e,goToUrlForTrail:r}}},2993:(e,t,r)=>{r.d(t,{E:()=>c});var n=r(6089),a=r(2007),i=r(5959),o=r.n(i),s=r(1159),l=r(6503);function c({error:e}){const t=(0,a.useStyles2)(u),r=(0,s.useNavigate)(),{pathname:n,search:c}=(0,s.useLocation)(),d=(0,i.useCallback)(()=>{const e=new URLSearchParams(c),t=new URLSearchParams;["from","to","timezone"].filter(t=>e.has(t)).forEach(r=>t.set(r,e.get(r))),r({pathname:n,search:t.toString()}),window.location.reload()},[r,n,c]);return o().createElement("div",{className:t.container},o().createElement(l._,{severity:"error",title:"Fatal error!",message:o().createElement(o().Fragment,null,"Please"," ",o().createElement(a.TextLink,{href:"#",onClick:d},"try reloading the page")," ","or, if the problem persists, contact your organization admin. Sorry for the inconvenience."),error:e,errorContext:{handheldBy:"React error boundary"}}))}function u(e){return{container:(0,n.css)({margin:e.spacing(2)})}}},3347:(e,t,r)=>{r.d(t,{h:()=>d,z:()=>c});var n=r(8531),a=r(4137),i=r(5176);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const l="grafana_explore_metrics_";function c(e,t){(0,n.reportInteraction)(`${l}${e}`,s(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){o(e,t,r[t])})}return e}({},t),{meta:{appRelease:n.config.apps[a.s_].version,appVersion:i.t}}))}function u(e,t){c("label_filter_changed",{label:e,action:t,cause:"adhoc_filter"})}function d(e,t){e.length===t.length?function(e,t){for(const r of t)for(const t of e)r.key===t.key&&r.value!==t.value&&u(r.key,"changed")}(e,t):e.length<t.length?function(e,t){for(const r of t)e.some(e=>e.key===r.key)||u(r.key,"removed")}(e,t):function(e,t){for(const r of e)!t.some(e=>e.key===r.key)&&u(r.key,"added")}(e,t)}},3422:(e,t,r)=>{r.d(t,{I:()=>o});var n=r(7985);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class o extends n.Bs{useCounts(){return this.useState().counts}constructor(e){super(i(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){a(e,t,r[t])})}return e}({},e),{counts:{current:0,total:0}}))}}},3616:(e,t,r)=>{r.d(t,{HA:()=>c,jx:()=>l});var n=r(7781),a=r(8531),i=r(2445);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function l(e,t){const r=t.reduce((e,t,r)=>s(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){o(e,t,r[t])})}return e}({},e),{[`info${r+1}`]:t}),{handheldBy:"displayError"});i.v.error(e,r),(0,a.getAppEvents)().publish({type:n.AppEvents.alertError.name,payload:t})}function c(e){i.v.warn(e),(0,a.getAppEvents)().publish({type:n.AppEvents.alertWarning.name,payload:e})}},3831:(e,t,r)=>{r.d(t,{a:()=>c,k:()=>l});var n=r(7985),a=r(5959),i=r.n(a),o=r(2445);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class l extends n.Bs{performRepeat(){var e,t;if(this._variableDependency.hasDependencyInLoadingState())return void this.setState({loadingLayout:null===(e=(t=this.state).getLayoutLoading)||void 0===e?void 0:e.call(t),errorLayout:void 0,emptyLayout:void 0,currentBatchSize:0});const r=n.jh.lookupVariable(this.state.variableName,this);if(!(r instanceof n.n8)){const e=new Error("SceneByVariableRepeater: variable is not a MultiValueVariable!");return void o.v.error(e)}var a,i;if(r.state.error)return void this.setState({errorLayout:null===(a=(i=this.state).getLayoutError)||void 0===a?void 0:a.call(i,r.state.error),loadingLayout:void 0,emptyLayout:void 0,currentBatchSize:0});const s=c(r);var l,u;if(!s.length)return void this.setState({emptyLayout:null===(l=(u=this.state).getLayoutEmpty)||void 0===l?void 0:l.call(u),errorLayout:void 0,loadingLayout:void 0,currentBatchSize:0});this.setState({loadingLayout:void 0,errorLayout:void 0,emptyLayout:void 0,currentBatchSize:this.state.initialPageSize});const d=s.slice(0,this.state.initialPageSize).map((e,t)=>this.state.getLayoutChild(e,t,s)).filter(Boolean);this.state.body.setState({children:d})}increaseBatchSize(){const e=c(n.jh.lookupVariable(this.state.variableName,this)),t=this.state.currentBatchSize+this.state.pageSizeIncrement,r=e.slice(this.state.currentBatchSize,t).map((t,r)=>this.state.getLayoutChild(t,this.state.currentBatchSize+r,e)).filter(Boolean);this.state.body.setState({children:[...this.state.body.state.children,...r]}),this.setState({currentBatchSize:t})}useSizes(){const{currentBatchSize:e,pageSizeIncrement:t}=this.useState(),r=n.jh.lookupVariable(this.state.variableName,this).state.options.length,a=r-e;return{increment:a<t?a:t,current:e,total:r}}constructor({variableName:e,body:t,getLayoutChild:r,getLayoutLoading:a,getLayoutError:i,getLayoutEmpty:o,initialPageSize:l,pageSizeIncrement:c}){super({variableName:e,body:t,getLayoutChild:r,getLayoutLoading:a,getLayoutError:i,getLayoutEmpty:o,currentBatchSize:0,initialPageSize:l||6,pageSizeIncrement:c||9,loadingLayout:void 0,errorLayout:void 0,emptyLayout:void 0}),s(this,"_variableDependency",new n.Sh(this,{variableNames:[this.state.variableName],onVariableUpdateCompleted:()=>this.performRepeat()})),this.addActivationHandler(()=>this.performRepeat())}}function c(e){const{value:t,text:r,options:n}=e.state;return e.hasAllValue()?n:Array.isArray(t)&&Array.isArray(r)?t.map((e,t)=>({value:e,label:r[t]})):[{value:t,label:r}]}s(l,"Component",({model:e})=>{const{body:t,loadingLayout:r,errorLayout:n,emptyLayout:a}=e.useState();return r?i().createElement(r.Component,{model:r}):n?i().createElement(n.Component,{model:n}):a?i().createElement(a.Component,{model:a}):i().createElement(t.Component,{model:t})})},4796:(e,t,r)=>{r.d(t,{y:()=>O,UX:()=>C,Vy:()=>x,aO:()=>k,aM:()=>E,kj:()=>y,KE:()=>v,xi:()=>S,FG:()=>j,ef:()=>w});var n=r(7781),a=r(8531),i=r(7985),o=(r(1269),r(2445)),s=r(4137),l=r(1955),c=r(9661),u=r(2127);r(2425);function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function p(){return new m}class m extends i.Bs{getSelectedScopes(){return this.selectedScopes}getSelectedScopesNames(){return this.selectedScopes.map(({scope:e})=>e.metadata.name)}setSelectedScopes(e){this.selectedScopes=e,this.notifySubscribers()}onScopesChange(e){return this.onScopesChangeCallbacks.push(e),()=>{this.onScopesChangeCallbacks=this.onScopesChangeCallbacks.filter(t=>t!==e)}}notifySubscribers(){for(const e of this.onScopesChangeCallbacks)e(this.selectedScopes)}get value(){return[]}constructor(){super({}),d(this,"selectedScopes",[]),d(this,"onScopesChangeCallbacks",[])}}var h=r(384);function b(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function f(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){b(i,n,a,o,s,"next",e)}function s(e){b(i,n,a,o,s,"throw",e)}o(void 0)})}}function g(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function y(e){return i.jh.getAncestor(e,l.b)}function v(e){return i.jh.getAncestor(e,l.b).state.settings}function w(e){var t,r;return new l.b(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){g(e,t,r[t])})}return e}({initialDS:null==e?void 0:e.initialDS,$timeRange:null!==(t=null==e?void 0:e.$timeRange)&&void 0!==t?t:new i.JZ({from:"now-1h",to:"now"}),embedded:null!==(r=null==e?void 0:e.embedded)&&void 0!==r&&r},e))}function S(e){const t=i.Go.getUrlState(e);return n.urlUtil.renderUrl(s.bw.Drilldown,t)}function O(e){return window.location.pathname.includes(e)}function E(e){if(e instanceof c.R)return e;if(e.parent)return E(e.parent);const t=new Error("Unable to find graph view for model");throw o.v.error(t,{model:e.toString(),message:"Unable to find graph view for model"}),t}function k(e){return e?e===u.td?"Logs":e:"All metrics"}function x(e){const t=a.config.theme2.visualization;return t.getColorByName(t.palette[e%8])}const P=1e4;function j(e,t,r){(0,h.BE)(t)&&t.setState({getTagKeysProvider:()=>f(function*(){var n;const a={filters:t.state.filters,scopes:null===(n=p())||void 0===n?void 0:n.value,queries:e.getQueries()};return a.queries.length>20&&(a.queries=[]),{replace:!0,values:(yield r.getTagKeys(a)).slice(0,P)}})(),getTagValuesProvider:(n,a)=>f(function*(){var n;const i=t.state.filters.filter(e=>e.key!==a.key),o={key:a.key,filters:i,scopes:null===(n=p())||void 0===n?void 0:n.value,queries:e.getQueries()};o.queries.length>20&&(o.queries=[]);return{replace:!0,values:(yield r.getTagValues(o)).slice(0,P)}})()})}function C(e,t,r){const n=i.jh.findObject(e,t);return n instanceof r?n:(null!==n&&o.v.warn(`invalid return type: ${r.toString()}`),null)}},4964:(e,t,r)=>{r.d(t,{_:()=>n});const n=new Intl.Collator("en",{sensitivity:"base"}).compare},5036:(e,t,r)=>{r.d(t,{k:()=>o});var n=r(7985),a=r(3241);function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class o{setInitOptions(e){this.initOptions=(0,a.cloneDeep)(e)}getFilters(){return this.filters}static getFilteredOptions(e,t){let r=e;return t.categories.length>0&&(r=o.applyCategoryFilters(r,t.categories)),t.prefixes.length>0&&(r=o.applyPrefixFilters(r,t.prefixes)),t.suffixes.length>0&&(r=o.applySuffixFilters(r,t.suffixes)),t.names.length>0&&(r=o.applyNameFilters(r,t.names)),r}applyFilters(e=this.filters,t={forceUpdate:!1,notify:!0}){const r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){i(e,t,r[t])})}return e}({},this.filters,e);if(!t.forceUpdate&&(0,a.isEqual)(this.filters,r))return;if(!(r.categories.length||r.prefixes.length||r.suffixes.length||r.names.length))return this.filters=r,this.variable.setState({options:this.initOptions}),void(t.notify&&this.notifyUpdate());this.filters=r;const n=o.getFilteredOptions(this.initOptions,this.filters);this.variable.setState({options:n}),t.notify&&this.notifyUpdate()}static applyCategoryFilters(e,t){let r=[];for(const n of t){const t=o.buildRegex(n,"i");r=r.concat(e.filter(e=>t.test(e.value)))}return r}static applyPrefixFilters(e,t){const r=t.map(e=>e.includes("|")?`${e.split("|").map(e=>`^${e}([^a-z0-9]|$)`).join("|")}`:`^${e}([^a-z0-9]|$)`).join("|"),n=o.buildRegex(`(${r})`);return e.filter(e=>n.test(e.value))}static applySuffixFilters(e,t){const r=t.map(e=>e.includes("|")?`${e.split("|").map(e=>`(^|[^a-z0-9])${e}$`).join("|")}`:`(^|[^a-z0-9])${e}$`).join("|"),n=o.buildRegex(`(${r})`);return e.filter(e=>n.test(e.value))}static applyNameFilters(e,t){const[r]=t,n=r.split(",").map(e=>e.trim()).filter(Boolean).map(e=>{try{return new RegExp(e)}catch(e){return null}}).filter(Boolean);return e.filter(e=>n.some(t=>t.test(e.value)))}static buildRegex(e,t){try{return new RegExp(e,t)}catch(e){return new RegExp(".*")}}notifyUpdate(){this.variable.publishEvent(new n.oh(this.variable),!0)}constructor(e){i(this,"variable",void 0),i(this,"initOptions",[]),i(this,"filters",{categories:[],prefixes:[],suffixes:[],names:[]}),this.variable=e}}},5317:(e,t,r)=>{r.d(t,{c:()=>f});var n=r(6089),a=r(7985),i=r(2007),o=r(5959),s=r.n(o),l=r(2445),c=r(384),u=r(1252),d=r(8499),p=r(9585),m=r(1709);function h(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function b(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class f extends a.Bs{_onActivate(){let e;try{e=a.jh.getAncestor(this,d.m)}catch(e){return}if(!e.state.enginesMap.get(p.h))return;const t=a.jh.findByKeyAndType(this,"metrics-sorter",u.fD),r=a.jh.getVariables(t).getByName(u.NJ);(0,c.UG)(r)&&(this.updateSortBy(t,r.getValue()),this._subs.add(r.subscribeToState(({value:e})=>{this.updateSortBy(t,e)})))}updateSortBy(e,t){this.setState({sortBy:t});const r=a.jh.getAncestor(this,a.gF),n=null==r?void 0:r.state.autoRows;switch(t){case"dashboard-usage":case"alerting-usage":e.getUsageForMetric(this.state.metric,t).then(e=>{this.setState({[t]:e})}),n!==m.iK&&r.setState({autoRows:m.iK});break;default:n!==m.tw&&r.setState({autoRows:m.tw})}}constructor(e){super(b(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){h(e,t,r[t])})}return e}({},e),{sortBy:"default","alerting-usage":0,"dashboard-usage":0})),this.addActivationHandler(this._onActivate.bind(this))}}function g({usageType:e,usageCount:t,singularUsageType:r,pluralUsageType:n,icon:a}){const o=(0,i.useStyles2)(y);return s().createElement("div",{className:o.usageContainer,"data-testid":"usage-data-panel"},s().createElement(i.Tooltip,{content:`Metric is used in ${t} ${1===t?r:n}`,placement:"top"},s().createElement("span",{className:o.usageItem,"data-testid":e},s().createElement(i.Icon,{name:a})," ",t)))}function y(e){return{usageContainer:(0,n.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start",gap:"17px",padding:"8px 12px",border:`1px solid ${e.colors.border.weak}`,borderTopWidth:0,backgroundColor:e.colors.background.primary,alignItems:"center"}),usageItem:(0,n.css)({display:"flex",alignItems:"center",gap:"4px",color:e.colors.text.secondary,opacity:"65%"})}}h(f,"Component",({model:e})=>{const{vizPanelInGridItem:t,sortBy:r,"alerting-usage":n,"dashboard-usage":a}=e.useState();if(!t)return void l.v.log("no viz panel");if("default"===r)return s().createElement("div",{"data-testid":"with-usage-data-preview-panel"},s().createElement(t.Component,{model:t}));const i={"dashboard-usage":{usageCount:a,singularUsageType:"dashboard panel query",pluralUsageType:"dashboard panel queries",icon:"apps"},"alerting-usage":{usageCount:n,singularUsageType:"alert rule",pluralUsageType:"alert rules",icon:"bell"}};return s().createElement("div",{"data-testid":"with-usage-data-preview-panel"},s().createElement(t.Component,{model:t}),s().createElement(g,{usageType:r,usageCount:i[r].usageCount,singularUsageType:i[r].singularUsageType,pluralUsageType:i[r].pluralUsageType,icon:i[r].icon}))})},5521:(e,t,r)=>{r.d(t,{O:()=>v,C:()=>y});var n=r(6089),a=r(7985),i=r(2007),o=r(5959),s=r.n(o),l=r(1053),c=r(7781),u=r(2127),d=r(2425),p=r(4796),m=r(384);const h=(e,t,r)=>e.length+2+t.length>r?t.substring(0,r-e.length-5)+"...":t;function b(e){const{onSelect:t,onDelete:r,bookmark:n}=e,l=(0,i.useStyles2)(f),b=(0,o.useMemo)(()=>{let t=e.trail||n&&(0,d._r)().getTrailForBookmark(n);if(!t)return null;const r=a.jh.lookupVariable(u.Ao,t);if(!(0,m.BE)(r))return null;const i=(null==n?void 0:n.createdAt)||t.state.createdAt;return{filters:r.state.filters,metric:t.state.metric,createdAt:i}},[e.trail,n]);if(!b)return null;const{filters:g,metric:y,createdAt:v}=b,w=h("",(0,p.aO)(y),27),S=`${e.compactHeight&&g.length>0?l.cardTall:""}`,O=`${l.card} ${e.wide?l.cardWide:""} ${S}`;return s().createElement("article",{"data-testid":`data-trail-card ${w}`},s().createElement(i.Card,{onClick:t,className:O},s().createElement(i.Card.Heading,null,s().createElement("div",{className:l.metricValue},w)),s().createElement(i.Card.Meta,{className:l.meta},g.map(e=>s().createElement("span",{key:e.key},s().createElement("div",{className:l.secondaryFont},e.key,": "),s().createElement("div",{className:l.primaryFont},h(e.key,e.value,44))))),s().createElement("div",{className:l.deleteButton},r&&s().createElement(i.Card.SecondaryActions,null,s().createElement(i.IconButton,{key:"delete",name:"trash-alt",className:l.secondary,tooltip:"Remove bookmark",onClick:r,"data-testid":"deleteButton"})))),s().createElement("div",{className:l.date},s().createElement("div",{className:l.secondaryFont},"Date created: "),s().createElement("div",{className:l.primaryFont},v>0&&(0,c.dateTimeFormat)(v,{format:"YYYY-MM-DD"}))))}function f(e){return{metricValue:(0,n.css)({display:"inline",color:e.colors.text.primary,fontWeight:500,wordBreak:"break-all"}),card:(0,n.css)({position:"relative",width:"318px",padding:`12px ${e.spacing(2)} ${e.spacing(1)} ${e.spacing(2)}`,alignItems:"start",marginBottom:0,borderTop:`1px solid ${e.colors.border.weak}`,borderRight:`1px solid ${e.colors.border.weak}`,borderLeft:`1px solid ${e.colors.border.weak}`,borderBottom:"none",borderRadius:"2px 2px 0 0"}),cardWide:(0,n.css)({width:"100%"}),cardTall:(0,n.css)({height:"110px"}),secondary:(0,n.css)({color:e.colors.text.secondary,fontSize:"12px"}),date:(0,n.css)({border:`1px solid ${e.colors.border.weak}`,borderRadius:"0 0 2px 2px",padding:`${e.spacing(1)} ${e.spacing(2)}`,backgroundColor:e.colors.background.primary}),meta:(0,n.css)({flexWrap:"wrap",overflow:"hidden",textOverflow:"ellipsis",maxHeight:"36px",margin:0,gridArea:"Meta",color:e.colors.text.secondary,whiteSpace:"nowrap"}),primaryFont:(0,n.css)({display:"inline",color:e.colors.text.primary,fontSize:"12px",fontWeight:"500",letterSpacing:"0.018px"}),secondaryFont:(0,n.css)({display:"inline",color:e.colors.text.secondary,fontSize:"12px",fontWeight:"400",lineHeight:"18px",letterSpacing:"0.018px"}),deleteButton:(0,n.css)({position:"absolute",bottom:e.spacing(1),right:e.spacing(1)})}}var g=r(3347);const y={listeners:new Set,emit:function(e){this.listeners.forEach(t=>t(e))},subscribe:function(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}};class v extends a.Bs{onActivate(){}constructor({key:e,title:t,description:r,icon:n,disabled:a}){super({key:e,title:t,description:r,icon:n,disabled:null!=a&&a,active:!1}),this.addActivationHandler(this.onActivate.bind(this))}}var w,S,O;function E(e){return{container:(0,n.css)({display:"flex",flexDirection:"column",gap:e.spacing(1),height:"100%"}),bookmarksList:(0,n.css)({display:"flex",flexDirection:"column",gap:e.spacing(1.5),overflowY:"auto",paddingRight:e.spacing(1)}),emptyState:(0,n.css)({display:"flex",justifyContent:"center",alignItems:"center",height:"100px",color:e.colors.text.secondary,fontStyle:"italic"})}}O=({model:e})=>{const t=(0,i.useStyles2)(E),{title:r,description:n}=e.useState(),{bookmarks:a}=(0,d._r)(),[,c]=(0,o.useState)(Date.now()),u=e=>{(0,g.z)("exploration_started",{cause:"bookmark_clicked"});const t=(0,d._r)().getTrailForBookmarkIndex(e);(0,d._r)().setRecentTrail(t),function(e){y.emit(e)}(t)};return s().createElement("div",{className:t.container},s().createElement(l._,{title:r,description:n,"data-testid":"bookmarks-list-sidebar"}),a.length>0?s().createElement("div",{className:t.bookmarksList},a.map((e,t)=>s().createElement(b,{key:(0,d.yn)(e),bookmark:e,onSelect:()=>u(t),onDelete:()=>(e=>{(0,g.z)("bookmark_changed",{action:"deleted"}),(0,d._r)().removeBookmark(e),c(Date.now())})(t),wide:!0,compactHeight:!0}))):s().createElement("div",{className:t.emptyState},"No bookmarks yet"))},(S="Component")in(w=v)?Object.defineProperty(w,S,{value:O,enumerable:!0,configurable:!0,writable:!0}):w[S]=O},5568:(e,t,r)=>{r.d(t,{$:()=>l,s:()=>c});var n=r(7781),a=r(7985),i=r(2127);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const l="metrics-wingman";class c extends a.fS{constructor(e){super(s(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){o(e,t,r[t])})}return e}({key:l,name:l,label:"Metrics"},e),{datasource:i.GH,query:`label_values({$${i.Ao}}, __name__)`,includeAll:!0,value:"$__all",skipUrlSync:!0,refresh:n.VariableRefresh.onTimeRangeChanged,sort:n.VariableSort.alphabeticalAsc,hide:n.VariableHide.hideVariable}))}}},5635:(e,t,r)=>{r.d(t,{MV:()=>y,Qs:()=>w,_O:()=>v});var n=r(6089),a=r(7985),i=r(6145),o=r(2007),s=r(5959),l=r.n(s),c=r(6503),u=r(2127),d=r(4796),p=r(384),m=r(8156),h=r(1709),b=r(5317),f=r(3831),g=r(2024);const y="repeat(auto-fit, minmax(400px, 1fr))",v="1fr";class w extends a.Bs{onActivate(){this.subscribeToLayoutChange()}subscribeToLayoutChange(){const e=a.jh.findByKeyAndType(this,"layout-switcher",m.U),t=this.state.body.state.body,r=(e,r)=>{e.layout!==(null==r?void 0:r.layout)&&t.setState({templateColumns:e.layout===m.p.ROWS?v:y})};r(e.state),this._subs.add(e.subscribeToState(r))}constructor({variableName:e}){super({key:"metrics-list",variableName:e,body:new f.k({variableName:e,initialPageSize:120,pageSizeIncrement:9,body:new a.gF({children:[],isLazy:!0,templateColumns:y,autoRows:h.tw,$behaviors:[new a.Gg.K2({key:"metricCrosshairSync",sync:i.yV.Crosshair})]}),getLayoutLoading:()=>new a.dM({reactNode:l().createElement(o.Spinner,{inline:!0})}),getLayoutEmpty:()=>new a.dM({reactNode:l().createElement(c._,{title:"",severity:"info"},"No metrics found for the current filters and time range.")}),getLayoutError:e=>new a.dM({reactNode:l().createElement(c._,{severity:"error",title:"Error while loading metrics!",error:e})}),getLayoutChild:(e,t)=>{const r=(0,d.kj)(this).isNativeHistogram(e.value),n=a.jh.lookupVariable(u.Ao,this),i=(0,p.BE)(n)?n.state.filters.map(e=>`${e.key}${e.operator}${e.value}`):[];return new a.xK({body:new b.c({vizPanelInGridItem:new h.yG({metricName:e.value,color:(0,d.Vy)(t),isNativeHistogram:r,matchers:i}),metric:e.value})})}})}),this.addActivationHandler(this.onActivate.bind(this))}}var S,O,E;function k(e){return{container:(0,n.css)({}),footer:(0,n.css)({display:"flex",justifyContent:"center",alignItems:"center",marginTop:e.spacing(4),"& button":{height:"40px",borderRadius:"8px"}})}}E=({model:e})=>{const{variableName:t,body:r}=e.useState(),n=(0,o.useStyles2)(k),i=a.jh.lookupVariable(t,e),{loading:s,error:c}=i.useState(),u=r.useSizes(),d=!s&&!c&&u.total>0&&u.current<u.total;return l().createElement("div",{"data-testid":"metrics-list"},l().createElement("div",{className:n.container},l().createElement(r.Component,{model:r})),d&&l().createElement("div",{className:n.footer},l().createElement(g.d,{label:"metric",batchSizes:u,onClick:()=>{r.increaseBatchSize()}})))},(O="Component")in(S=w)?Object.defineProperty(S,O,{value:E,enumerable:!0,configurable:!0,writable:!0}):S[O]=E},5749:(e,t,r)=>{r.d(t,{R:()=>p,q:()=>d});var n=r(8531),a=r(7985),i=r(3616),o=r(2127),s=r(7476);function l(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function c(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){l(i,n,a,o,s,"next",e)}function s(e){l(i,n,a,o,s,"throw",e)}o(void 0)})}}function u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class d{reset(){this._datasource=void 0,this._metricsMetadata=void 0,this._classicHistograms={},this._nativeHistograms=[]}getDatasource(){return c(function*(){if(this._datasource)return this._datasource;const e=yield(0,n.getDataSourceSrv)().get(o.gR,{__sceneObject:{value:this._trail}});return(0,s.aQ)(e)&&(this._datasource=e),this._datasource}).call(this)}_ensureMetricsMetadata(){return c(function*(){this._metricsMetadata||(yield this._getMetricsMetadata())}).call(this)}_getMetricsMetadata(){return c(function*(){const e=yield this.getDatasource();if(!e)return;const t="function"==typeof e.languageProvider.queryMetricsMetadata?e.languageProvider.queryMetricsMetadata:()=>Promise.resolve(e.languageProvider.metricsMetadata),r="function"==typeof e.languageProvider.retrieveMetricsMetadata?()=>Promise.resolve(e.languageProvider.retrieveMetricsMetadata()):()=>e.languageProvider.loadMetricsMetadata().then(()=>t());let n=yield t();n||(n=yield r()),this._metricsMetadata=n}).call(this)}getMetadataForMetric(e){return c(function*(){var t;if(e)return yield this._ensureMetricsMetadata(),null===(t=this._metricsMetadata)||void 0===t?void 0:t[e]}).call(this)}listNativeHistograms(){return this._nativeHistograms}initializeHistograms(){return c(function*(){const e=yield this.getDatasource();if(e&&0===Object.keys(this._classicHistograms).length){const t=e.metricFindQuery("metrics(.*_bucket)"),r=e.metricFindQuery("metrics(.+)"),[n,a]=yield Promise.all([t,r]);n.forEach(e=>{this._classicHistograms[e.text]=1}),yield this._ensureMetricsMetadata(),a.forEach(e=>{this.isNativeHistogram(e.text)&&this.addNativeHistogram(e.text)})}}).call(this)}isNativeHistogram(e){var t;if(!e)return!1;const r=this._metricsMetadata;var n;const a="bucket"!==(null!==(n=e.split("_").pop())&&void 0!==n?n:"");return!("histogram"!==(null==r||null===(t=r[e])||void 0===t?void 0:t.type)||!a)||this._classicHistograms[`${e}_bucket`]>0}addNativeHistogram(e){this._nativeHistograms.includes(e)||this._nativeHistograms.push(e)}getTagKeys(e){return c(function*(){const t=yield this.getDatasource();if(!t)return[];return yield t.getTagKeys(e)}).call(this)}getTagValues(e){return c(function*(){const t=yield this.getDatasource();if(!t)return[];e.key=function(e){if(""===e||!function(e){return/^".*"$/.test(e)}(e))return e;return e.slice(1,-1)}(e.key);return yield t.getTagValues(e)}).call(this)}static dsUsesTimeRangeInLegacyLanguageProviderMethods(e){return"function"==typeof e.languageProvider.fetchLabelValues&&e.languageProvider.fetchLabelValues.length>1}static fetchLabels(e){const{ds:t,timeRange:r,matcher:n}=e;return"function"==typeof t.languageProvider.queryLabelKeys?t.languageProvider.queryLabelKeys(r,n):d.dsUsesTimeRangeInLegacyLanguageProviderMethods(t)?t.languageProvider.fetchLabelsWithMatch(r,n).then(e=>Object.keys(e)):t.languageProvider.fetchLabelsWithMatch(n).then(e=>Object.keys(e))}static fetchLabelValues(e){const{ds:t,labelName:r,timeRange:n,matcher:a}=e;if("function"==typeof t.languageProvider.queryLabelValues)return t.languageProvider.queryLabelValues(n,r,a);const i=a?t.languageProvider.fetchSeriesValuesWithMatch:t.languageProvider.fetchLabelValues;return d.dsUsesTimeRangeInLegacyLanguageProviderMethods(t)?i(n,r,a):i(r,a)}static getPrometheusDataSourceForScene(e){return c(function*(){try{const r=a.jh.findByKey(e,o.EY);var t;const i=null!==(t=null==r?void 0:r.state.value)&&void 0!==t?t:"";return yield(0,n.getDataSourceSrv)().get({uid:i})}catch(e){return void(0,i.jx)(e,["Error while getting the Prometheus data source!"])}})()}constructor(e){u(this,"_trail",void 0),u(this,"_datasource",void 0),u(this,"_metricsMetadata",void 0),u(this,"_classicHistograms",{}),u(this,"_nativeHistograms",[]),this._trail=e}}function p(e){if(!e)return;const{type:t,help:r,unit:n}=e;return[r,t&&`**Type:** *${t}*`,n&&`**Unit:** ${n}`].join("\n\n")}},6096:(e,t,r)=>{r.d(t,{c:()=>h});var n=r(7985),a=r(3823),i=r.n(a);const o=new Map;function s(e,t){let r=o.get(e);r||(r=new Map,o.set(e,r));let n=r.get(t);if(!n){const a=e.split("_"),o=a.slice(0,a.length/2).join("_");n={halfLeven:i()(o,t)||0,wholeLeven:i()(e,t)||0},r.set(t,n)}return n}var l=r(2445),c=r(1252),u=r(1199);function d(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function p(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){d(i,n,a,o,s,"next",e)}function s(e){d(i,n,a,o,s,"throw",e)}o(void 0)})}}function m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class h{sort(){return p(function*(e=this.sortBy,t={}){const r=this.variable.state.options.map(e=>e.value);if(e===this.sortBy&&(0,u.B)(r,this.lastMetrics))return;let n;switch(e){case"dashboard-usage":case"alerting-usage":n=yield this.sortByUsage(r,e);break;case"related":a=r,i=t.metric,n=a.sort((e,t)=>{const r=s(e,i),n=s(t,i);return r.halfLeven+r.wholeLeven-(n.halfLeven+n.wholeLeven)});break;default:n=(0,c.Rm)(r)}var a,i;this.sortBy=e,this.lastMetrics=n,this.variable.setState({options:n.map(e=>({label:e,value:e}))}),this.notifyUpdate()}).apply(this,arguments)}sortByUsage(e,t){return p(function*(){try{const r=n.jh.findByKeyAndType(this.variable,"metrics-sorter",c.fD);if(!r)return l.v.warn("Metrics sorter not found. Returning unsorted metrics.",{usageType:t}),e;const a=yield r.getUsageMetrics(t);return(0,c.yH)(e,a)}catch(r){const n="string"==typeof r?new Error(r):r;return l.v.error(n,{usageType:t}),e}}).call(this)}notifyUpdate(){this.variable.publishEvent(new n.oh(this.variable),!0)}constructor(e){m(this,"variable",void 0),m(this,"lastMetrics",void 0),m(this,"sortBy",void 0),this.variable=e,this.sortBy=void 0,this.lastMetrics=[]}}},6503:(e,t,r)=>{r.d(t,{_:()=>c});var n=r(2007),a=r(5959),i=r.n(a),o=r(2445);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function c({severity:e,title:t,message:r,error:a,errorContext:c,children:u}){let d;return a&&(d="string"==typeof a?new Error(a):a,o.v.error(d,l(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){s(e,t,r[t])})}return e}({},d.cause||{},c),{bannerTitle:t}))),i().createElement(n.Alert,{title:t,severity:e},d&&i().createElement(i().Fragment,null,d.message||d.toString(),i().createElement("br",null)),r,u)}},6920:(e,t,r)=>{r.d(t,{e:()=>s});var n,a,i,o=r(7781);class s extends o.BusEventWithPayload{}i="metrics-variable-deactivated",(a="type")in(n=s)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i},7019:(e,t,r)=>{function n(e,t){return(null==t?void 0:t.state.embedded)||e.isLight?e.colors.background.primary:e.colors.background.canvas}r.d(t,{T:()=>n})},7238:(e,t,r)=>{r.d(t,{I:()=>m});var n=r(6089),a=r(7985),i=r(2007),o=r(3241),s=r(5959),l=r.n(s),c=r(3347),u=r(2127),d=r(1816);function p(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class m extends a.Bs{getUrlState(){return{[this.state.urlSearchParamName]:this.state.value}}updateFromUrl(e){const t=e[this.state.urlSearchParamName]||"";t!==this.state.value&&this.setState({value:t})}toggleCountsDisplay(e){this.setState({displayCounts:e})}updateValue(e){""===this.state.value&&""!==e&&(0,c.z)("quick_search_used",{}),this.setState({value:e}),this.notifyValueChange(e)}useHumanFriendlyCountsMessage(){const{targetName:e,countsProvider:t,displayCounts:r}=this.state,n=t.useCounts();return r?n.current===n.total?{tagName:`${n.current}`,tooltipContent:1!==n.current?`${n.current} ${e}s in total`:`1 ${e} in total`}:{tagName:`${n.current}/${n.total}`,tooltipContent:1!==n.current?`${n.current} out of ${n.total} ${e}s in total`:`1 out of ${n.total} ${e}s in total`}:{tagName:"",tooltipContent:""}}constructor({urlSearchParamName:e,targetName:t,countsProvider:r,displayCounts:n}){super({key:"quick-search",urlSearchParamName:e,targetName:t,countsProvider:r,displayCounts:Boolean(n),value:""}),p(this,"_variableDependency",new a.Sh(this,{variableNames:[u.EY],onReferencedVariableValueChanged:()=>{this.setState({value:""})}})),p(this,"_urlSync",new a.So(this,{keys:[this.state.urlSearchParamName]})),p(this,"notifyValueChange",(0,o.debounce)(e=>{this.publishEvent(new d.W({searchText:e}),!0)},250)),p(this,"onChange",e=>{this.updateValue(e.currentTarget.value)}),p(this,"clear",()=>{this.updateValue("")}),p(this,"onKeyDown",e=>{"Escape"===e.key&&(e.preventDefault(),this.clear())})}}p(m,"Component",({model:e})=>{const t=(0,i.useStyles2)(h),{targetName:r,value:n,countsProvider:a}=e.useState(),{tagName:o,tooltipContent:s}=e.useHumanFriendlyCountsMessage();return l().createElement(i.Input,{value:n,onChange:e.onChange,onKeyDown:e.onKeyDown,placeholder:`Quick search ${r}s`,prefix:l().createElement("i",{className:"fa fa-search"}),suffix:l().createElement(l().Fragment,null,l().createElement(a.Component,{model:a}),o&&l().createElement(i.Tooltip,{content:s,placement:"top"},l().createElement(i.Tag,{className:t.counts,name:o,colorIndex:9})),l().createElement(i.IconButton,{name:"times",variant:"secondary",tooltip:"Clear search",onClick:e.clear,disabled:!n}))})});const h=e=>({counts:n.css`
    margin-right: ${e.spacing(1)};
    border-radius: 11px;
    padding: 2px ${e.spacing(1)};
    color: ${e.colors.text.primary};
    background-color: ${e.colors.background.secondary};
  `})},7265:(e,t,r)=>{function n(e){var t,r;if(!e)return;const i=null!==(r=e.state.$data)&&void 0!==r?r:null===(t=e.parent)||void 0===t?void 0:t.state.$data;return a(i)?i:null!=(o=i)&&"state"in o&&"transformations"in o.state?n(i):void 0;var o}function a(e){return null!=e&&"state"in e&&"runQueries"in e}r.d(t,{un:()=>n,xT:()=>a})},7397:(e,t,r)=>{r.d(t,{x:()=>s});var n,a,i,o=r(7781);class s extends o.BusEventWithPayload{}i="metrics-variable-loaded",(a="type")in(n=s)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i},7437:(e,t,r)=>{r.d(t,{MM:()=>h,l_:()=>m});const n="none",a="cps",i="bytes",o="seconds",s="percent",l="count",c={[i]:i,[o]:"s",[s]:s,[l]:n},u=Object.keys(c),d={[i]:"Bps",[o]:n,[l]:a,[s]:s};function p(e){if(!e)return null;const t=e.toLowerCase().split("_").slice(-2);for(let e=t.length-1;e>=Math.max(0,t.length-2);e--){const r=t[e];if(u.includes(r))return r}return null}function m(e){if(!e)return n;const t=p(e);return t&&c[t.toLowerCase()]||n}function h(e){if(!e)return a;const t=p(e);return t&&d[t]||a}},7476:(e,t,r)=>{r.d(t,{aQ:()=>c,tS:()=>p});var n=r(8531),a=r(2445);function i(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function o(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var o=e.apply(t,r);function s(e){i(o,n,a,s,l,"next",e)}function l(e){i(o,n,a,s,l,"throw",e)}s(void 0)})}}function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const l=/^grafana-[0-9a-z]+prometheus-datasource$/;function c(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&("prometheus"===e.type||l.test(e.type))&&"uid"in e&&"string"==typeof e.uid}class u{getHealthyDataSources(e){return o(function*(){const t=this.cache.get(e);if(null==t?void 0:t.length)return t;let r=this.pendingRequests.get(e);r||(r=this.fetchHealthyDataSources(e).finally(()=>{this.pendingRequests.delete(e)}),this.pendingRequests.set(e,r));const n=yield r;return this.cache.set(e,n),n}).call(this)}fetchHealthyDataSources(e){return o(function*(){const t=(0,n.getDataSourceSrv)().getList({logs:!0,type:e,filter:e=>"grafana"!==e.uid}),r=[],i=[];return yield Promise.all(t.map(e=>o(function*(){try{const t=yield(0,n.getBackendSrv)().get(`/api/datasources/uid/${e.uid}/health`,void 0,void 0,{showSuccessAlert:!1,showErrorAlert:!1});"OK"===(null==t?void 0:t.status)?r.push(e):i.push(e)}catch(t){i.push(e)}})())),i.length>0&&a.v.warn(`Found ${i.length} unhealthy ${e} data sources: ${i.map(e=>e.name).join(", ")}`),r})()}constructor(){s(this,"pendingRequests",new Map),s(this,"cache",new Map)}}let d;function p(){return d||(d=new u),d}},8156:(e,t,r)=>{r.d(t,{U:()=>c,p:()=>l});var n=r(7985),a=r(2007),i=r(5959),o=r.n(i);function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var l=function(e){return e.GRID="grid",e.ROWS="rows",e.SINGLE="single",e}({});class c extends n.Bs{getUrlState(){return{[this.state.urlSearchParamName]:this.state.layout}}updateFromUrl(e){const t={},r=e[this.state.urlSearchParamName];r!==this.state.layout&&(t.layout=this.state.options.find(e=>e.value===r)?r:c.DEFAULT_LAYOUT),this.setState(t)}constructor({urlSearchParamName:e,options:t}){super({key:"layout-switcher",urlSearchParamName:e||"layout",options:t||c.DEFAULT_OPTIONS,layout:c.DEFAULT_LAYOUT}),s(this,"_urlSync",new n.So(this,{keys:[this.state.urlSearchParamName]})),s(this,"onChange",e=>{this.setState({layout:e})})}}s(c,"DEFAULT_OPTIONS",[{label:"Grid",value:"grid"},{label:"Rows",value:"rows"}]),s(c,"DEFAULT_LAYOUT","grid"),s(c,"Component",({model:e})=>{const{options:t,layout:r}=e.useState();return o().createElement(a.RadioButtonGroup,{"aria-label":"Layout switcher",options:t,value:r,onChange:e.onChange,fullWidth:!1})})},8361:(e,t,r)=>{r.d(t,{S:()=>s});var n,a,i,o=r(7781);class s extends o.BusEventWithPayload{}i="sort-by-changed",(a="type")in(n=s)?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i},8499:(e,t,r)=>{r.d(t,{m:()=>rt});var n=r(6089),a=r(7781),i=r(8531),o=r(7985),s=r(2007),l=r(5959),c=r.n(l),u=r(3347),d=r(4796),p=r(2127),m=r(6503),h=r(5749),b=r(384),f=r(3616),g=r(4964);function y(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function v(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){y(i,n,a,o,s,"next",e)}function s(e){y(i,n,a,o,s,"throw",e)}o(void 0)})}}const w="(none)";class S extends o.UU{query(){return v(function*(){return{state:a.LoadingState.Done,data:[{name:"Labels",fields:[{name:null,type:a.FieldType.other,values:[],config:{}}],length:0}]}})()}metricFindQuery(e,t){return v(function*(){var r,n;const a=null===(n=t.scopedVars)||void 0===n||null===(r=n.__sceneObject)||void 0===r?void 0:r.valueOf(),i=yield h.q.getPrometheusDataSourceForScene(a);if(!i)return[];var o;const[,s]=null!==(o=e.match(/valuesOf\((.+)\)/))&&void 0!==o?o:[];if(s){return(yield S.fetchLabelValues(s,a)).map(e=>({value:e,text:e}))}let l=[];try{l=yield this.fetchLabels(i,a,e)}catch(e){(0,f.HA)(["Error while fetching labels! Defaulting to an empty array.",e.toString()])}return[{value:w,text:"(none)"},...l]}).call(this)}fetchLabels(e,t,r){return v(function*(){if(!S.getLabelsMatchAPISupport(e)){const r=S.getFiltersFromVariable(t),n=yield e.getTagKeys(r);return this.processLabelOptions(n.map(({text:e})=>({value:e,text:e})))}const n=yield h.q.fetchLabels({ds:e,timeRange:o.jh.getTimeRange(t).state.value,matcher:r});return this.processLabelOptions(n.map(e=>({value:e,text:e})))}).call(this)}static getLabelsMatchAPISupport(e){try{return e.hasLabelsMatchAPISupport()}catch(e){return(0,f.HA)(["Error while checking if the current data source supports the labels match API! Defaulting to false.",e.toString()]),!1}}static getFiltersFromVariable(e){const t=o.jh.lookupVariable(p.Ao,e);return(0,b.BE)(t)?{filters:t.state.filters}:{filters:[]}}processLabelOptions(e){return e.filter(({value:e})=>!e.startsWith("__")).sort((e,t)=>(0,g._)(e.value,t.value))}static fetchLabelValues(e,t){return v(function*(){const r=yield h.q.getPrometheusDataSourceForScene(t);if(!r)return[];try{return yield h.q.fetchLabelValues({ds:r,labelName:e,timeRange:o.jh.getTimeRange(t).state.value})}catch(t){return(0,f.HA)([`Error while retrieving label "${e}" values! Defaulting to an empty array.`,t.toString()]),[]}})()}testDatasource(){return v(function*(){return{status:"success",message:"OK"}})()}constructor(){super(S.uid,S.uid)}}var O,E,k;k="grafana-prometheus-labels-datasource",(E="uid")in(O=S)?Object.defineProperty(O,E,{value:k,enumerable:!0,configurable:!0,writable:!0}):O[E]=k;const x="wingmanLabelValues";class P extends o.fS{constructor({labelName:e}){super({name:x,datasource:{uid:S.uid},query:`valuesOf(${e})`,isMulti:!1,allowCustomValue:!1,refresh:a.VariableRefresh.onTimeRangeChanged,hide:a.VariableHide.hideVariable,value:"$__all",includeAll:!0})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(P,"Component",()=>c().createElement(c().Fragment,null));var j=r(3831),C=r(2024);const _="labelsWingman";class L extends o.fS{onActivate(){this._subs.add(this.subscribeToState((e,t)=>{e.query!==t.query&&(t.query&&this.setState({value:w}),this.refreshOptions())})),this._subs.add(o.jh.findByKeyAndType(this,p.EY,o.mI).subscribeToState((e,t)=>{e.value!==t.value&&(this.setState({value:w}),this.refreshOptions())})),this._subs.add(o.jh.findByKeyAndType(this,p.Ao,o.H9).subscribeToState((e,t)=>{e.filterExpression!==t.filterExpression&&this.updateQuery()})),this.updateQuery()}updateQuery(){const e=o.jh.interpolate(this,p.ui,{});this.setState({query:`{__name__=~".+",${e}}`})}constructor(){super({name:_,label:"Group by label",placeholder:"Group by label...",datasource:{uid:S.uid},query:"",includeAll:!1,isMulti:!1,allowCustomValue:!1,refresh:a.VariableRefresh.onTimeRangeChanged,hide:a.VariableHide.hideVariable}),this.addActivationHandler(this.onActivate.bind(this))}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(L,"Component",({model:e})=>{const t=(0,s.useStyles2)(N),{label:r}=e.useState();return c().createElement("div",{className:t.container},c().createElement(s.Label,{className:t.label},r),c().createElement(o.fS.Component,{model:e}))});const N=e=>({container:n.css`
    display: flex;
    align-items: center;
    gap: 0;

    [class*='input-wrapper'] {
      width: 240px;
    }
  `,label:n.css`
    height: 32px;
    white-space: nowrap;
    margin: 0;
    background-color: ${e.colors.background.primary};
    padding: ${e.spacing(1)};
    border-radius: ${e.shape.radius.default};
    border: 1px solid ${e.colors.border.weak};
    border-right: none;
  `});var D=r(8156),A=r(5635),B=r(8534),T=r(1709),$=r(5317);function M(){return c().createElement("svg",{stroke:"currentColor",width:"17",height:"16",viewBox:"0 0 17 16",fill:"none"},c().createElement("circle",{cx:"8.92688",cy:"3.63132",r:"2.375",strokeWidth:"1.5"}),c().createElement("path",{d:"M13.6469 4.37965C14.6813 4.76699 15.3235 7.03139 14.9362 8.06582",strokeWidth:"1.5"}),c().createElement("path",{d:"M4.35309 4.37965C3.31866 4.76699 2.67651 7.03139 3.06384 8.06582",strokeWidth:"1.5"}),c().createElement("path",{d:"M10.3408 14.2531C9.75237 14.8415 8.11813 14.7799 7.50903 14.1708",strokeWidth:"1.5"}),c().createElement("circle",{cx:"4.00195",cy:"12.251",r:"2.375",strokeWidth:"1.5"}),c().createElement("circle",{cx:"13.8478",cy:"12.251",r:"2.375",strokeWidth:"1.5"}))}var I=r(1464);function R(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function F(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){R(i,n,a,o,s,"next",e)}function s(e){R(i,n,a,o,s,"throw",e)}o(void 0)})}}class V extends o.UU{query(){return F(function*(){return{state:a.LoadingState.Done,data:[{name:"Labels",fields:[{name:null,type:a.FieldType.other,values:[],config:{}}],length:0}]}})()}metricFindQuery(e,t){return F(function*(){var r,n;const a=null===(n=t.scopedVars)||void 0===n||null===(r=n.__sceneObject)||void 0===r?void 0:r.valueOf(),i=yield h.q.getPrometheusDataSourceForScene(a);if(!i)return[];const s=o.jh.getTimeRange(a).state.value;let l=[];const c=e.startsWith("removeRules"),u=c?e.replace("removeRules",""):e;return l=yield h.q.fetchLabelValues({ds:i,labelName:"__name__",matcher:u,timeRange:s}),c&&(l=l.filter(e=>!(e=>"ALERTS"===e||"ALERTS_FOR_STATE"===e||e.includes(":"))(e))),l.map(e=>({value:e,text:e}))})()}testDatasource(){return F(function*(){return{status:"success",message:"OK"}})()}constructor(){super(V.uid,V.uid)}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(V,"uid","grafana-prometheus-metrics-with-label-values-datasource");const H="metrics-with-label-value";class z extends o.fS{onActivate(e,t,r){const n=o.jh.lookupVariable(p.Ao,this);(null==n?void 0:n.state.hide)!==a.VariableHide.hideVariable&&this.setState({query:z.buildQuery(e,t,r)})}static buildQuery(e,t,r){return r?`removeRules{${e}="${t}",${p.ui}}`:`{${e}="${t}",${p.ui}}`}constructor({labelName:e,labelValue:t,removeRules:r}){return super({key:`${H}-${e}-${t}`,name:H,datasource:{uid:V.uid},query:z.buildQuery(e,t,r),isMulti:!1,allowCustomValue:!1,refresh:a.VariableRefresh.onTimeRangeChanged,hide:a.VariableHide.hideVariable,skipUrlSync:!0,value:"$__all",includeAll:!0}),this.addActivationHandler(this.onActivate.bind(this,e,t,r)),(0,I.I)(this)}}class U extends o.Bs{onActivate(){this.subscribeToLayoutChange()}subscribeToLayoutChange(){const e=o.jh.findByKeyAndType(this,"layout-switcher",D.U),t=this.state.body.state.body,r=(e,r)=>{e.layout!==(null==r?void 0:r.layout)&&t.setState({templateColumns:e.layout===D.p.ROWS?A._O:A.MV})};r(e.state),this._subs.add(e.subscribeToState(r))}constructor({index:e,labelName:t,labelValue:r,labelCardinality:n}){super({index:e,labelName:t,labelValue:r,labelCardinality:n,key:`${t||""}-${r||""}`,$variables:new o.Pj({variables:[new z({labelName:t,labelValue:r})]}),body:new j.k({variableName:H,initialPageSize:3,body:new o.gF({children:[],isLazy:!0,templateColumns:A.MV,autoRows:T.iK,$behaviors:[new o.Gg.K2({key:"metricCrosshairSync",sync:a.DashboardCursorSync.Crosshair})]}),getLayoutLoading:()=>new o.dM({reactNode:c().createElement(s.Spinner,{inline:!0})}),getLayoutEmpty:()=>new o.dM({reactNode:c().createElement(m._,{title:"",severity:"info"},"No metrics found for the current filters and time range.")}),getLayoutError:e=>new o.dM({reactNode:c().createElement(m._,{severity:"error",title:"Error while loading metrics!",error:e})}),getLayoutChild:(e,n)=>{const a=(0,d.kj)(this).isNativeHistogram(e.value);return new o.xK({body:new $.c({vizPanelInGridItem:new T.yG({metricName:e.value,color:(0,d.Vy)(n),matchers:[`${t}="${r}"`],headerActions:[new B.B({metricName:e.value})],isNativeHistogram:a}),metric:e.value})})}})}),this.addActivationHandler(this.onActivate.bind(this))}}function q(e){return{container:(0,n.css)({background:e.colors.background.canvas,margin:e.spacing(1,0,0,0),"& div:focus-within":{boxShadow:"none !important"}}),containerHeader:(0,n.css)({display:"flex",alignItems:"center",gap:"8px",marginBottom:"-36px",paddingBottom:e.spacing(1.5),borderBottom:`1px solid ${e.colors.border.medium}`}),headerButtons:(0,n.css)({position:"relative",top:"3px",marginLeft:"auto",marginRight:"30px",zIndex:100}),selectButton:(0,n.css)({height:"28px"}),collapsableSectionBody:(0,n.css)({display:"flex",flexDirection:"column",gap:"24px",padding:e.spacing(1)}),groupName:(0,n.css)({display:"flex",alignItems:"center",fontSize:"1.3rem",lineHeight:"1.3rem"}),labelValue:(0,n.css)({fontSize:"16px",marginLeft:"8px"}),index:(0,n.css)({fontSize:"12px",color:e.colors.text.secondary,marginLeft:"8px"}),footer:(0,n.css)({display:"flex",justifyContent:"center",alignItems:"center",marginTop:e.spacing(1),"& button":{height:"40px"}}),variable:(0,n.css)({display:"none"})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(U,"Component",({model:e})=>{const[t,r]=(0,l.useState)(!1),n=(0,s.useStyles2)(q),{index:a,labelName:i,labelValue:u,labelCardinality:d,$variables:m,body:h}=e.useState(),b=m.state.variables[0],{loading:f,error:g}=b.useState(),y=h.useSizes(),v=!f&&!g&&y.total>0&&y.current<y.total;return c().createElement("div",{className:n.container,"data-testid":`${i}-${u}-metrics-group`},c().createElement("div",{className:n.containerHeader},c().createElement("div",{className:n.headerButtons},c().createElement(s.Button,{className:n.selectButton,variant:"secondary",onClick:()=>{var t;const r=o.jh.lookupVariable(p.Ao,e);r.setState({filters:[...r.state.filters,{key:i,operator:"=",value:u}]}),null===(t=o.jh.lookupVariable(_,e))||void 0===t||t.changeValueTo(w)},tooltip:`See metrics with ${i}=${u}`,tooltipPlacement:"top"},"Select"))),c().createElement(s.CollapsableSection,{isOpen:!t,onToggle:()=>r(!t),label:c().createElement("div",{className:n.groupName},c().createElement(M,null),c().createElement("div",{className:n.labelValue},u),d>1&&c().createElement("div",{className:n.index},"(",a+1,"/",d,")"))},c().createElement("div",{className:n.collapsableSectionBody},c().createElement(h.Component,{model:h})),v&&c().createElement("div",{className:n.footer},c().createElement(C.d,{label:"metric",batchSizes:y,onClick:()=>{h.increaseBatchSize()},tooltip:`Show more metrics for ${i}="${u}"`}))),c().createElement("div",{className:n.variable},c().createElement(b.Component,{key:b.state.name,model:b})))});class G extends o.Bs{constructor({labelName:e}){super({key:"metrics-group-list",labelName:e,$variables:new o.Pj({variables:[new P({labelName:e})]}),body:new j.k({variableName:x,initialPageSize:20,pageSizeIncrement:10,body:new o.gF({children:[],isLazy:!0,templateColumns:"1fr",autoRows:"auto",rowGap:1}),getLayoutLoading:()=>new o.dM({reactNode:c().createElement(s.Spinner,{inline:!0})}),getLayoutEmpty:()=>new o.dM({reactNode:c().createElement(m._,{title:"",severity:"info"},'No label values found for label "',e,'".')}),getLayoutError:t=>new o.dM({reactNode:c().createElement(m._,{severity:"error",title:`Error while loading label "${e}" values!`,error:t})}),getLayoutChild:(t,r,n)=>new o.xK({body:new U({index:r,labelName:e,labelValue:t.value,labelCardinality:n.length})})})})}}function Q(e){return{footer:(0,n.css)({display:"flex",justifyContent:"center",alignItems:"center",margin:e.spacing(3,0,1,0),"& button":{height:"40px"}}),variable:(0,n.css)({display:"none"})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(G,"Component",({model:e})=>{const t=(0,s.useStyles2)(Q),{body:r,$variables:n,labelName:a}=e.useState(),i=n.state.variables[0],{loading:o,error:l}=i.useState(),u=r.useSizes(),d=!o&&!l&&u.total>0&&u.current<u.total;return c().createElement("div",{"data-testid":"metrics-groupby-list"},c().createElement(r.Component,{model:r}),d&&c().createElement("div",{className:t.footer},c().createElement(C.d,{label:`"${a}" value`,batchSizes:u,onClick:()=>{r.increaseBatchSize()}})),c().createElement("div",{className:t.variable},c().createElement(i.Component,{key:i.state.name,model:i})))});var W=r(1252),K=r(9966),Y=r(7238);function J(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Z(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class X extends o.P1{constructor(e){super(Z(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){J(e,t,r[t])})}return e}({},e),{key:"list-controls",body:new o.G1({direction:"row",width:"100%",maxHeight:"32px",children:[new o.vA({body:new Y.I({urlSearchParamName:"search_txt",targetName:"metric",countsProvider:new K.s})}),new o.vA({width:"auto",body:new W.fD({})}),new o.vA({width:"auto",body:new D.U({})})]})}))}}function ee(){return{headerWrapper:(0,n.css)({display:"flex",alignItems:"center","& > div":{display:"flex",alignItems:"center","& > div":{display:"flex",alignItems:"center"}}})}}J(X,"Component",({model:e})=>{const t=(0,s.useStyles2)(ee),{body:r}=e.useState();return c().createElement("div",{className:t.headerWrapper},c().createElement(r.Component,{model:r}))});var te=r(8361),re=r(1816),ne=r(697),ae=r(6920),ie=r(7397),oe=r(9585),se=r(5568),le=r(5036),ce=r(6096);class ue extends a.BusEventWithPayload{}function de(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(ue,"type","apply-function");class pe extends o.Bs{constructor({metricName:e,prometheusFunction:t,disabled:r}){super({key:`apply-action-${e}`,metricName:e,prometheusFunction:t,disabled:Boolean(r)}),de(this,"onClick",e=>{const{metricName:t,prometheusFunction:r}=this.state;e.preventDefault(),this.publishEvent(new ue({metricName:t,prometheusFunction:r}),!0)})}}de(pe,"Component",({model:e})=>{const t=(0,s.useStyles2)(me),{disabled:r}=e.useState();return c().createElement(s.Button,{variant:"primary",fill:"outline",size:"sm",className:t.selectButton,onClick:e.onClick,disabled:r},"Apply")});const me=()=>({selectButton:n.css``});class he extends a.BusEventWithPayload{}function be(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(he,"type","configure-function");class fe extends o.Bs{constructor({metricName:e}){super({key:`configure-action-${e}`,metricName:e}),be(this,"onClick",()=>{this.publishEvent(new he({metricName:this.state.metricName}),!0)})}}be(fe,"PROMETHEUS_FN_OPTIONS",[{label:"Average",value:"avg"},{label:"Sum",value:"sum"},{label:"Minimum",value:"min"},{label:"Maximum",value:"max"},{label:"Rate",value:"rate"}]),be(fe,"Component",({model:e})=>{const t=(0,s.useStyles2)(ge);return c().createElement(s.Button,{className:t.selectButton,"aria-label":"Configure",variant:"secondary",size:"sm",fill:"text",onClick:e.onClick,icon:"cog",tooltip:"Configure the Prometheus function",tooltipPlacement:"top"})});const ge=()=>({selectButton:n.css`
    margin: 0;
    padding: 0;
  `});function ye(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ve(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){ye(e,t,r[t])})}return e}function we(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class Se extends o.Bs{constructor(e){super(ve({key:"drawer",isOpen:!1},e)),ye(this,"open",({title:e,subTitle:t,body:r})=>{this.setState(we(ve({},this.state),{isOpen:!0,title:e,subTitle:t,body:r}))}),ye(this,"close",()=>{this.setState({isOpen:!1})})}}ye(Se,"Component",({model:e})=>{const{isOpen:t,title:r,subTitle:n,body:a}=e.useState();return c().createElement(c().Fragment,null,a&&t&&c().createElement(s.Drawer,{size:"lg",title:r,subtitle:n,closeOnMaskClick:!0,onClose:e.close},c().createElement(a.Component,{model:a})))});var Oe=r(28),Ee=r(2445);const ke="Non-rules metrics",xe="Recording rules";class Pe extends a.BusEventWithPayload{}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(Pe,"type","section-value-changed");var je=r(1053);const Ce=({label:e,count:t,checked:r,onChange:n})=>{const a=(0,s.useStyles2)(_e);return c().createElement("div",{className:a.checkboxWrapper,title:e},c().createElement(s.Checkbox,{label:e,value:r,onChange:n}),c().createElement("span",{className:a.count},"(",t,")"))};function _e(e){return{checkboxWrapper:(0,n.css)({display:"flex",alignItems:"center",width:"100%","& label *":{fontSize:"14px !important",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}),count:(0,n.css)({color:e.colors.text.secondary,marginLeft:e.spacing(.5),display:"inline-block"})}}function Le({groups:e,selectedGroups:t,onSelectionChange:r}){const n=(0,s.useStyles2)(Ne);return c().createElement(c().Fragment,null,c().createElement("div",{className:n.checkboxListHeader},c().createElement("div",null,t.length," selected"),c().createElement(s.Button,{variant:"secondary",fill:"text",onClick:()=>r([]),disabled:!t.length},"clear")),!e.length&&c().createElement("div",{className:n.noResults},"No results."),e.length>0&&c().createElement("ul",{className:n.checkboxList,"data-testid":"checkbox-filters-list"},e.map(e=>c().createElement("li",{key:e.value,className:n.checkboxItem},c().createElement(Ce,{label:e.label,count:e.count,checked:t.some(t=>t.value===e.value),onChange:n=>{const a=n.currentTarget.checked?[...t,{label:e.label,value:e.value}]:t.filter(t=>t.value!==e.value);r(a)}})))))}function Ne(e){return{checkboxListHeader:(0,n.css)({display:"flex",justifyContent:"space-between",alignItems:"center",color:e.colors.text.secondary,margin:e.spacing(0),padding:e.spacing(0,0,0,1)}),checkboxList:(0,n.css)({height:"100%",margin:0,padding:e.spacing(0,1,1,1),overflowY:"auto","& .css-1n4u71h-Label":{fontSize:"14px !important"},"&::-webkit-scrollbar":{"-webkit-appearance":"none",width:"7px"},"&::-webkit-scrollbar-thumb":{borderRadius:"4px",backgroundColor:e.colors.secondary.main,"-webkit-box-shadow":`0 0 1px ${e.colors.secondary.shade}`}}),checkboxItem:(0,n.css)({display:"flex",alignItems:"center",width:"100%",padding:e.spacing(.5,0)}),noResults:(0,n.css)({fontStyle:"italic",padding:e.spacing(0,1,1,1)})}}function De(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Ae(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){De(e,t,r[t])})}return e}function Be(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class Te extends o.Bs{getUrlState(){return{[this.state.key]:this.state.selectedGroups.map(e=>e.value).join(",")}}updateFromUrl(e){const t={};"string"==typeof e[this.state.key]&&e[this.state.key]!==this.state.selectedGroups.map(e=>e.value).join(",")&&(t.selectedGroups=e[this.state.key].split(",").map(e=>({label:e,value:e}))),this.setState(t)}onActivate(){const e=o.jh.lookupVariable(se.$,this),t=o.jh.lookupVariable(oe.h,this);this.updateLists(e.state.options),this.updateCounts();const{selectedGroups:r}=this.state;this.setState({loading:t.state.loading,active:r.length>0})}updateLists(e){this.setState({groups:this.state.computeGroups(e),loading:!1})}updateCounts(){var e;const{groups:t,computeGroups:r,type:n}=this.state,a=o.jh.lookupVariable(se.$,this).state.options,i=null===(e=o.jh.getAncestor(this,rt).state.enginesMap.get(oe.h))||void 0===e?void 0:e.filterEngine;if(!i)return void Ee.v.warn("MetricsFilterSection: No filter engine found");const s=Be(Ae({},i.getFilters()),{[n]:[]}),l=le.k.getFilteredOptions(a,s),c=new Map(r(l).map(e=>[e.label,e.count])),u=t.map(e=>{var t;return Be(Ae({},e),{count:null!==(t=c.get(e.label))&&void 0!==t?t:0})});this.setState({groups:u,loading:!1})}constructor({key:e,type:t,title:r,description:n,icon:a,computeGroups:i,showHideEmpty:s,showSearch:l,disabled:c,active:d}){super({key:e,type:t,title:r,description:n,icon:a,groups:[],computeGroups:i,selectedGroups:[],loading:!0,showHideEmpty:null==s||s,showSearch:null==l||l,disabled:null!=c&&c,active:null!=d&&d}),De(this,"_variableDependency",new o.Sh(this,{variableNames:[se.$,oe.h],onReferencedVariableValueChanged:e=>{const{name:t,options:r}=e.state;t!==se.$?t===oe.h&&this.updateCounts():this.updateLists(r)}})),De(this,"_urlSync",new o.So(this,{keys:[this.state.key]})),De(this,"onSelectionChange",e=>{this.setState({selectedGroups:e,active:e.length>0}),this.publishEvent(new Oe.Y({type:this.state.type,filters:e.map(e=>e.value)}),!0),this.publishEvent(new Pe({key:this.state.key,values:e.map(e=>e.label)}),!0),"prefixes"===this.state.type?(0,u.z)("sidebar_prefix_filter_applied",{filter_count:e.length}):"suffixes"===this.state.type&&(0,u.z)("sidebar_suffix_filter_applied",{filter_count:e.length}),"filters-rule"===this.state.key&&e.length>0&&e.forEach(e=>{let t;switch(e.label){case ke:t="non_rules_metrics";break;case xe:t="recording_rules";break;default:return}(0,u.z)("sidebar_rules_filter_selected",{filter_type:t})})}),this.addActivationHandler(this.onActivate.bind(this))}}function $e(e){return{container:(0,n.css)({display:"flex",flexDirection:"column",gap:e.spacing(1),height:"100%",overflowY:"hidden"}),switchContainer:(0,n.css)({display:"flex",alignItems:"center",justifyContent:"flex-end",gap:e.spacing(1)}),switchLabel:(0,n.css)({fontSize:"12px",color:e.colors.text.primary}),searchInput:(0,n.css)({flexBasis:"32px",flexShrink:0,marginBottom:e.spacing(1),padding:e.spacing(0,.5)})}}De(Te,"Component",({model:e})=>{const t=(0,s.useStyles2)($e),{groups:r,selectedGroups:n,loading:a,title:i,description:o,showHideEmpty:u,showSearch:d}=e.useState(),[p,m]=(0,l.useState)(!1),[h,b]=(0,l.useState)(""),f=(0,l.useMemo)(()=>{const e=[];return p&&e.push(e=>e.count>0),e.push(e=>e.label.toLowerCase().includes(h.toLowerCase())),r.filter(t=>e.every(e=>e(t)))},[p,r,h]);return c().createElement("div",{className:t.container},c().createElement(je._,{title:i,description:o}),u&&c().createElement("div",{className:t.switchContainer},c().createElement("span",{className:t.switchLabel},"Hide empty"),c().createElement(s.Switch,{value:p,onChange:e=>m(e.currentTarget.checked)})),d&&c().createElement(s.Input,{className:t.searchInput,prefix:c().createElement(s.Icon,{name:"search"}),placeholder:"Search...",value:h,onChange:e=>b(e.currentTarget.value),onKeyDown:e=>{"Escape"===e.key&&(e.preventDefault(),b(""))},suffix:c().createElement(s.IconButton,{name:"times",variant:"secondary",tooltip:"Clear search",onClick:()=>b("")})}),a&&c().createElement(s.Spinner,{inline:!0}),!a&&c().createElement(Le,{groups:f,selectedGroups:n,onSelectionChange:e.onSelectionChange}))});var Me=r(8628);function Ie(e){const t=new Map;for(const n of e){const e=n.value.split(/[^a-z0-9]/i),a=e.length<=1?n.value:e[e.length-1];var r;const i=null!==(r=t.get(a))&&void 0!==r?r:[];i.push(n.value),t.set(a||"<none>",i)}const n=new Map;for(const[e,r]of t)n.set(e,r.length);return Array.from(n.entries()).sort((e,t)=>e[1]!==t[1]?t[1]-e[1]:(0,g._)(e[0],t[0])).map(([e,t])=>({value:e,count:t,label:e}))}function Re(e){const t=new Map([["metrics",[]],["rules",[]]]);for(const n of e){const{value:e}=n,a=/:/i.test(e)?"rules":"metrics";var r;const i=null!==(r=t.get(a))&&void 0!==r?r:[];i.push(e),t.set(a,i)}return[{value:"^(?!.*:.*)",label:ke,count:t.get("metrics").length},{value:":",label:xe,count:t.get("rules").length}]}var Fe=r(5521);function Ve({labels:e,selectedLabel:t,onClickLabel:r,onClickClearSelection:n}){const a=(0,s.useStyles2)(He);return c().createElement(c().Fragment,null,c().createElement("div",{className:a.listHeader},c().createElement("div",{className:a.selected},t===w?"No selection":`Selected: "${t}"`),c().createElement(s.Button,{variant:"secondary",fill:"text",onClick:n,disabled:t===w},"clear")),!e.length&&c().createElement("div",{className:a.noResults},"No results."),e.length>0&&c().createElement("div",{className:a.list,"data-testid":"labels-list"},c().createElement(s.RadioButtonList,{name:"labels-list",options:e,onChange:r,value:t})))}function He(e){return{listHeader:(0,n.css)({display:"flex",justifyContent:"space-between",alignItems:"center",color:e.colors.text.secondary,margin:e.spacing(0),padding:e.spacing(0,0,0,1)}),selected:(0,n.css)({overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}),list:(0,n.css)({display:"flex",flex:1,flexDirection:"column",gap:0,overflowY:"auto",'& [role="radiogroup"]':{gap:0},"& label":{cursor:"pointer",padding:e.spacing(.5,1),"&:hover":{background:e.colors.background.secondary}},"& label div":{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}),noResults:(0,n.css)({fontStyle:"italic",padding:e.spacing(0,1,1,1)})}}function ze(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Ue extends o.Bs{onActivate(){const e=o.jh.lookupVariable(this.state.variableName,this),t=e.state.value;this.setState({active:Boolean(t&&t!==w)}),this._subs.add(e.subscribeToState(e=>{const t=Boolean(e.value&&e.value!==w);this.setState({active:t}),this.publishEvent(new Pe({key:this.state.key,values:t?[e.value]:[]}),!0)}))}selectLabel(e){o.jh.lookupVariable(this.state.variableName,this).changeValueTo(e);const t=Boolean(e&&e!==w);this.setState({active:t}),this.publishEvent(new Pe({key:this.state.key,values:t?[e]:[]}),!0)}constructor({key:e,variableName:t,title:r,description:n,icon:a,disabled:i,active:s}){super({key:e,variableName:t,title:r,description:n,icon:a,disabled:null!=i&&i,active:null!=s&&s}),ze(this,"onClickLabel",e=>{(0,u.z)("sidebar_group_by_label_filter_applied",{label:e}),this.selectLabel(e)}),ze(this,"onClickClearSelection",()=>{this.selectLabel(w)}),ze(this,"useLabelsBrowser",()=>{const{variableName:e,title:t,description:r}=this.useState(),n=o.jh.lookupVariable(e,this),{loading:a,options:i,value:s}=n.useState(),[c,u]=(0,l.useState)("");return{title:t,description:r,loading:a,selectedLabel:s,labelsList:(0,l.useMemo)(()=>{const e=[e=>e!==w,e=>e.toLowerCase().includes(c.toLowerCase())];return i.filter(t=>e.every(e=>e(t.value)))},[i,c]),searchValue:c,onInputChange:e=>{u(e.currentTarget.value)},onInputKeyDown:e=>{"Escape"===e.key&&(e.preventDefault(),u(""))},onInputClear:()=>{u("")}}}),this.addActivationHandler(this.onActivate.bind(this))}}function qe(e){return{container:(0,n.css)({display:"flex",flexDirection:"column",gap:e.spacing(1),height:"100%",overflowY:"hidden"}),search:(0,n.css)({marginBottom:e.spacing(1),padding:e.spacing(0,.5)})}}ze(Ue,"Component",({model:e})=>{const t=(0,s.useStyles2)(qe),{title:r,description:n,loading:a,labelsList:i,selectedLabel:o,searchValue:l,onInputChange:u,onInputKeyDown:d,onInputClear:p}=e.useLabelsBrowser();return c().createElement("div",{className:t.container,"data-testid":"labels-browser"},c().createElement(je._,{title:r,description:n}),c().createElement(s.Input,{className:t.search,prefix:c().createElement(s.Icon,{name:"search"}),placeholder:"Search...",value:l,onChange:u,onKeyDown:d,suffix:c().createElement(s.IconButton,{name:"times",variant:"secondary",tooltip:"Clear search",onClick:p})}),a&&c().createElement(s.Spinner,{inline:!0}),!a&&c().createElement(Ve,{labels:i,selectedLabel:o,onClickLabel:e.onClickLabel,onClickClearSelection:e.onClickClearSelection}))});class Ge extends o.Bs{onActivate(){}constructor({key:e,title:t,description:r,icon:n,disabled:a}){super({key:e,title:t,description:r,icon:n,disabled:null!=a&&a,active:!1}),this.addActivationHandler(this.onActivate.bind(this))}}function Qe(e){return{container:(0,n.css)({display:"flex",flexDirection:"column",gap:e.spacing(1),height:"100%",overflowY:"hidden"})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(Ge,"Component",({model:e})=>{const t=(0,s.useStyles2)(Qe),{title:r,description:n}=e.useState();return c().createElement("div",{className:t.container},c().createElement(je._,{title:r,description:n}))});const We=new Map([["rules",function(){return c().createElement("svg",{stroke:"currentColor",width:"16",height:"16",viewBox:"0 0 16 16",fill:"none"},c().createElement("rect",{x:"1.25",y:"1.625",width:"5.25",height:"5.25",rx:"1",strokeWidth:"1.5"}),c().createElement("circle",{cx:"12.25",cy:"4.25",r:"2.75",strokeWidth:"1.5"}),c().createElement("circle",{cx:"3.75",cy:"11.75",r:"2.75",strokeWidth:"1.5"}),c().createElement("rect",{x:"9.5",y:"9.125",width:"5.25",height:"5.25",rx:"1",strokeWidth:"1.5"}))}],["groups",M]]);function Ke({ariaLabel:e,disabled:t,visible:r,active:i,tooltip:o,iconOrText:l,onClick:u}){const d=(0,s.useStyles2)(Ye);let p,m;return l in a.availableIconsIndex?p=l:m=We.has(l)?We.get(l):function(){return c().createElement(c().Fragment,null,l)},c().createElement(s.Button,{className:(0,n.cx)(d.button,t&&"disabled",r&&"visible",i&&"active"),size:"md",variant:"secondary",fill:"text",icon:p,"aria-label":e,tooltip:o,tooltipPlacement:"right",onClick:u,disabled:t},m&&c().createElement(m,null))}function Ye(e){return{button:(0,n.css)({margin:0,color:e.colors.text.secondary,"&:hover":{color:e.colors.text.maxContrast,background:"transparent"},"&.disabled:hover":{color:e.colors.text.secondary},"&.visible":{color:e.colors.text.maxContrast},"&.active":{color:e.colors.text.maxContrast}})}}function Je(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Ze=["filters-rule","filters-prefix","filters-suffix"];class Xe extends o.Bs{onActivate(){const e=this.initOtherMetricsVar();return this._subs.add(this.subscribeToEvent(Pe,e=>{const{key:t,values:r}=e.payload,{sectionValues:n}=this.state,a=new Map(n).set(t,r);this.setOtherMetricFilters(a),this.setState({sectionValues:a})})),()=>{e()}}setOtherMetricFilters(e){const t=o.jh.lookupVariable(p.hc,this);if(!(0,b.BE)(t))return;const r={"filters-rule":"rule group","filters-prefix":"prefix","filters-suffix":"suffix"},n=Array.from(e.entries()).reduce((e,[t,n])=>(n.length&&Ze.includes(t)&&e.push({key:t,operator:"=",value:n.join(", "),keyLabel:r[t]}),e),[]);t.setState({filters:n,hide:n.length?a.VariableHide.hideLabel:a.VariableHide.hideVariable})}initOtherMetricsVar(){const e=(0,d.kj)(this).state.$variables;if(!e)return()=>{};const t=new o.H9({name:p.hc,readOnly:!0,skipUrlSync:!0,datasource:null,hide:a.VariableHide.hideVariable,layout:"combobox",applyMode:"manual",allowCustomValue:!0});return e.setState({variables:[...e.state.variables,t]}),this.setOtherMetricFilters(this.state.sectionValues),()=>{e.setState({variables:[...e.state.variables.filter(e=>e!==t)]})}}static getSectionValuesFromUrl(){const e=new URLSearchParams(window.location.search),t=new Map;for(const r of Ze){const n=e.get(r);t.set(r,n?n.split(",").map(e=>e.trim()):[])}const r=e.get(`var-${_}`);return Boolean(r&&r!==w)&&t.set("groupby-labels",[r]),t}setActiveSection(e){const{visibleSection:t,sections:r}=this.state;if(!e||e===(null==t?void 0:t.state.key))return(0,u.z)("metrics_sidebar_toggled",{action:"closed",section:null==t?void 0:t.state.key}),void this.setState({visibleSection:null});var n;(0,u.z)("metrics_sidebar_toggled",{action:"opened",section:e}),"filters-prefix"===e?(0,u.z)("sidebar_prefix_filter_section_clicked",{}):"filters-suffix"===e&&(0,u.z)("sidebar_suffix_filter_section_clicked",{}),this.setState({visibleSection:null!==(n=r.find(t=>t.state.key===e))&&void 0!==n?n:null})}constructor(e){var t,r,n;const a=Xe.getSectionValuesFromUrl();super(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Je(e,t,r[t])})}return e}({key:"sidebar",visibleSection:null,sections:[new Te({key:"filters-rule",type:"categories",title:"Rules filters",description:"Filter metrics and recording rules",icon:"rules",computeGroups:Re,showHideEmpty:!1,showSearch:!1,active:Boolean(null===(t=a.get("filters-rule"))||void 0===t?void 0:t.length)}),new Te({key:"filters-prefix",type:"prefixes",title:"Prefix filters",description:"Filter metrics based on their name prefix (Prometheus namespace)",icon:"A_",computeGroups:Me.w,active:Boolean(null===(r=a.get("filters-prefix"))||void 0===r?void 0:r.length)}),new Te({key:"filters-suffix",type:"suffixes",title:"Suffix filters",description:"Filter metrics based on their name suffix",icon:"_Z",computeGroups:Ie,active:Boolean(null===(n=a.get("filters-suffix"))||void 0===n?void 0:n.length)}),new Ue({key:"groupby-labels",variableName:_,title:"Group by labels",description:"Group metrics by their label values",icon:"groups",active:a.has("groupby-labels")}),new Fe.O({key:"bookmarks",title:"Bookmarks",description:"Access your saved metrics for quick reference",icon:"star"}),new Ge({key:"settings",title:"Settings",description:"Settings",icon:"cog",disabled:!0})],sectionValues:a},e)),a.set("filters-rule",[]),this.addActivationHandler(this.onActivate.bind(this))}}function et(e){return{container:(0,n.css)({position:"relative",display:"flex",flexDirection:"row",height:"100%",overflow:"hidden"}),buttonsBar:(0,n.css)({display:"flex",flexDirection:"column",alignItems:"center",gap:0,width:"42px",padding:0,margin:0,boxSizing:"border-box",border:`1px solid ${e.colors.border.weak}`,borderRadius:e.shape.radius.default,backgroundColor:e.colors.background.primary,borderTopLeftRadius:0,borderBottomLeftRadius:0,position:"relative"}),buttonContainer:(0,n.css)({marginTop:e.spacing(1),"&::before":{transition:"0.5s ease",content:'""',position:"absolute",left:0,height:"32px",borderLeft:`2px solid ${e.colors.action.selectedBorder}`,boxSizing:"border-box",opacity:0,visibility:"hidden"},"&:hover::before":{opacity:1,visibility:"visible"},"&.visible::before":{opacity:1,visibility:"visible"},"&.disabled::before":{opacity:0,visibility:"hidden"},"&.active::after":{content:'""',position:"absolute",right:0,width:"8px",height:"8px",backgroundColor:e.colors.action.selectedBorder,borderRadius:"50%",margin:"2px 4px 0 0"}}),content:(0,n.css)({width:"calc(300px - 42px)",boxSizing:"border-box",border:`1px solid ${e.colors.border.weak}`,borderLeft:"none",borderRadius:e.shape.radius.default,backgroundColor:e.colors.background.canvas,padding:e.spacing(1.5)}),closeButton:(0,n.css)({position:"absolute",top:e.spacing(1.5),right:e.spacing(1),margin:0})}}function tt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Je(Xe,"Component",({model:e})=>{const t=(0,s.useStyles2)(et),{sections:r,visibleSection:a,sectionValues:i}=e.useState();return c().createElement("div",{className:t.container},c().createElement("div",{className:t.buttonsBar,"data-testid":"sidebar-buttons"},r.map(r=>{var o,s;const{key:l,title:u,icon:d,disabled:p,active:m}=r.state,h=(null==a?void 0:a.state.key)===l,b=(null===(o=i.get(l))||void 0===o?void 0:o.length)?`${u}: ${null===(s=i.get(l))||void 0===s?void 0:s.join(", ")}`:u;return c().createElement("div",{key:l,className:(0,n.cx)(t.buttonContainer,h&&"visible",m&&"active",p&&"disabled")},c().createElement(Ke,{ariaLabel:u,disabled:p,visible:h,active:m,tooltip:b,onClick:()=>e.setActiveSection(l),iconOrText:d}))})),a&&c().createElement("div",{className:t.content,"data-testid":"sidebar-content"},c().createElement(s.IconButton,{className:t.closeButton,name:"times","aria-label":"Close",tooltip:"Close",tooltipPlacement:"top",onClick:()=>e.setActiveSection("")}),a instanceof Te&&c().createElement(a.Component,{model:a}),a instanceof Ue&&c().createElement(a.Component,{model:a}),a instanceof Fe.O&&c().createElement(a.Component,{model:a}),a instanceof Ge&&c().createElement(a.Component,{model:a})))});class rt extends o.Bs{onActivate(){const e=o.jh.lookupVariable(_,this).state.value;this.updateBasedOnGroupBy(e),this.subscribeToEvents()}updateBasedOnGroupBy(e){const t=Boolean(e&&e!==w);o.jh.findByKeyAndType(this,"quick-search",Y.I).toggleCountsDisplay(!t),this.setState({body:t?new G({labelName:e}):new A.Qs({variableName:oe.h})})}subscribeToEvents(){this.initVariablesFilteringAndSorting(),this._subs.add(this.subscribeToEvent(he,e=>{this.openDrawer(e.payload.metricName)})),this._subs.add(this.subscribeToEvent(ue,()=>{this.state.drawer.close()})),this._subs.add(this.subscribeToEvent(p.OO,e=>{void 0!==e.payload&&(0,W.VN)(e.payload)}))}initVariablesFilteringAndSorting(){this._subs.add(this.subscribeToEvent(ne.x,e=>{const{key:t}=e.payload,r=o.jh.findByKey(this,t);this.state.enginesMap.set(t,{filterEngine:new le.k(r),sortEngine:new ce.c(r)})})),this._subs.add(this.subscribeToEvent(ae.e,e=>{this.state.enginesMap.delete(e.payload.key)}));const e=o.jh.findByKeyAndType(this,"quick-search",Y.I),t=o.jh.findAllObjects(this,e=>e instanceof Te),r=o.jh.findByKeyAndType(this,"metrics-sorter",W.fD).state.$variables.getByName(W.NJ);this._subs.add(this.subscribeToEvent(ie.x,n=>{const{key:a,options:i}=n.payload,{filterEngine:o,sortEngine:s}=this.state.enginesMap.get(a);o.setInitOptions(i);const l={names:e.state.value?[e.state.value]:[]};for(const e of t)l[e.state.type]=e.state.selectedGroups.map(e=>e.value);o.applyFilters(l,{forceUpdate:!0,notify:!1}),s.sort(r.state.value)})),this._subs.add(this.subscribeToEvent(re.W,e=>{const{searchText:t}=e.payload;for(const[,{filterEngine:e,sortEngine:n}]of this.state.enginesMap)e.applyFilters({names:t?[t]:[]}),n.sort(r.state.value)})),this._subs.add(this.subscribeToEvent(Oe.Y,e=>{const{type:t,filters:n}=e.payload;for(const[,{filterEngine:e,sortEngine:a}]of this.state.enginesMap)e.applyFilters({[t]:n}),a.sort(r.state.value)})),this._subs.add(this.subscribeToEvent(te.S,e=>{const{sortBy:t}=e.payload;(0,u.z)("sorting_changed",{from:"metrics-reducer",sortBy:t});for(const[,{sortEngine:e}]of this.state.enginesMap)e.sort(t)}))}openDrawer(e){const t=(0,d.kj)(this);this.state.drawer.open({title:"Choose a new Prometheus function",subTitle:e,body:new o.gF({templateColumns:A.MV,autoRows:T.Rg,isLazy:!0,$behaviors:[new o.Gg.K2({key:"metricCrosshairSync",sync:a.DashboardCursorSync.Crosshair})],children:fe.PROMETHEUS_FN_OPTIONS.map((r,n)=>new o.xK({body:new T.yG({title:r.label,metricName:e,color:(0,d.Vy)(n),prometheusFunction:r.value,height:T.Rg,hideLegend:!0,highlight:1===n,isNativeHistogram:t.isNativeHistogram(e),headerActions:[new pe({metricName:e,prometheusFunction:r.value,disabled:1===n})]})}))})})}constructor(){super({$variables:new o.Pj({variables:[new se.s,new oe.V,new L]}),listControls:new X({}),sidebar:new Xe({}),body:new A.Qs({variableName:oe.h}),drawer:new Se({}),enginesMap:new Map}),tt(this,"_variableDependency",new o.Sh(this,{variableNames:[_],onReferencedVariableValueChanged:e=>{this.updateBasedOnGroupBy(e.state.value)}})),function(e){try{for(const t of e)(0,o.pY)({dataSource:t})}catch(e){const{message:t}=e;/A runtime data source with uid (.+) has already been registered/.test(t)||(0,f.jx)(e,["Fail to register all the runtime data sources!","The application cannot work as expected, please try reloading the page or if the problem persists, contact your organization admin."])}}([new S,new V]),this.addActivationHandler(this.onActivate.bind(this))}}tt(rt,"Component",({model:e})=>{var t;const r=null!==(t=(0,i.useChromeHeaderHeight)())&&void 0!==t?t:0,n=(0,s.useStyles2)(at,r),{$variables:a,body:o,listControls:l,drawer:u,sidebar:d}=e.useState();return c().createElement(c().Fragment,null,c().createElement("div",{className:n.listControls,"data-testid":"list-controls"},c().createElement(l.Component,{model:l})),c().createElement("div",{className:n.body},c().createElement("div",{className:n.sidebar,"data-testid":"sidebar"},c().createElement(d.Component,{model:d})),c().createElement("div",{className:n.list},c().createElement(o.Component,{model:o}))),c().createElement("div",{className:n.variables},null==a?void 0:a.state.variables.map(e=>c().createElement(e.Component,{key:e.state.name,model:e}))),c().createElement(u.Component,{model:u}))});const nt=144;function at(e,t){return{listControls:(0,n.css)({marginBottom:e.spacing(1.5)}),body:(0,n.css)({display:"flex",flexDirection:"row",gap:e.spacing(1),height:`calc(100vh - ${t+nt}px)`}),list:(0,n.css)({width:"100%",overflowY:"auto"}),sidebar:(0,n.css)({flex:"0 0 auto",overflowY:"auto"}),variables:(0,n.css)({display:"none"})}}},8534:(e,t,r)=>{r.d(t,{B:()=>c});var n=r(7985),a=r(2007),i=r(5959),o=r.n(i),s=r(2127);function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class c extends n.Bs{constructor({metricName:e,variant:t,fill:r}){super({key:`select-action-${e}`,metricName:e,variant:t||"primary",fill:r||"outline"}),l(this,"onClick",()=>{this.publishEvent(new s.OO(this.state.metricName),!0)})}}l(c,"Component",({model:e})=>{const{variant:t,fill:r}=e.useState();return o().createElement(a.Button,{variant:t,fill:r,size:"sm",onClick:e.onClick,"data-testid":`select-action-${e.state.metricName}`},"Select")})},8628:(e,t,r)=>{r.d(t,{w:()=>i});var n=r(4964);const a="<none>";function i(e){const t=new Map;for(const n of e){const e=n.value.split(/[^a-z0-9]/i),i=e.length<=1?n.value:e[0];var r;const o=null!==(r=t.get(i))&&void 0!==r?r:[];o.push(n.value),t.set(i||a,o)}const i=new Map;for(const[e,r]of t)i.set(e,r.length);return Array.from(i.entries()).sort((e,t)=>e[1]!==t[1]?t[1]-e[1]:(0,n._)(e[0],t[0])).map(([e,t])=>({value:e,count:t,label:e}))}},8732:(e,t,r)=>{r.d(t,{A:()=>l,S:()=>u});var n=r(5959),a=r.n(n),i=r(1159),o=r(4137),s=r(2745);const l=(0,n.lazy)(()=>r.e(78).then(r.bind(r,9078))),c=()=>{const e=(0,i.useLocation)();return a().createElement(i.Navigate,{to:`${o.bw.Drilldown}${e.search}`,replace:!0})},u=()=>{const{trail:e}=(0,n.useContext)(s.J);return a().createElement(i.Routes,null,a().createElement(i.Route,{path:o.bw.Drilldown,element:a().createElement(l,{trail:e})}),a().createElement(i.Route,{path:o.bw.Trail,element:a().createElement(c,null)}),a().createElement(i.Route,{path:"*",element:a().createElement(i.Navigate,{to:o.bw.Drilldown,replace:!0})}))}},9585:(e,t,r)=>{r.d(t,{V:()=>s,h:()=>o});var n=r(7985),a=r(5568),i=r(1464);const o="filtered-metrics-wingman";class s extends n.yP{onActivate(){const e=n.jh.findByKeyAndType(this,a.$,a.s),{loading:t,error:r,options:i}=e.state;this.setState({loading:t,error:r,options:i}),this._subs.add(e.subscribeToState(e=>{this.setState({loading:e.loading,error:e.error,options:e.options})}))}constructor(){return super({key:o,name:o,label:"Filtered Metrics",loading:!1,error:null,options:[],includeAll:!0,value:"$__all",skipUrlSync:!0}),this.addActivationHandler(this.onActivate.bind(this)),(0,i.I)(this)}}},9661:(e,t,r)=>{r.d(t,{R:()=>Or});var n=r(6089),a=r(8531),i=r(7985),o=r(2007),s=r(5959),l=r.n(s),c=r(3347);var u,d,p,m=r(2127),h=r(384);class b extends i.fS{onActivate(){this.subscribeToState((e,t)=>{e.value&&e.value!==t.value&&(0,c.z)("groupby_label_changed",{label:String(e.value)})});const e=i.jh.lookupVariable(m.Ao,this);(0,h.BE)(e)&&e.subscribeToState((e,t)=>{e.filterExpression!==t.filterExpression&&this.changeValueTo("$__all")})}constructor(){super({name:m.yr,label:"Group by",datasource:m.GH,includeAll:!0,defaultToAll:!0,query:`label_names(${m.Rp})`,value:"",text:""}),this.addActivationHandler(this.onActivate.bind(this))}}function f(e){return{select:n.css`
      width: ${e.spacing(16)};
      & > div {
        width: 100%;
      }
    `}}p=({model:e})=>{const t=(0,o.useStyles2)(f);return l().createElement("div",{className:t.select,"data-testid":"breakdown-label-selector"},l().createElement(i.fS.Component,{model:e}))},(d="Component")in(u=b)?Object.defineProperty(u,d,{value:p,enumerable:!0,configurable:!0,writable:!0}):u[d]=p;var g=r(5749),y=r(1269),v=r(2445);const w=r.p+"ac01ecbc64128d2f3e68.svg";var S=r(4796),O=r(2533),E=r(7265);function k(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function x(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){k(e,t,r[t])})}return e}function P(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const j=`${O.id}/investigation/v1`;class C extends i.Bs{getPanelConfigAndDataFrames(){var e;const t=(0,S.UX)(this,e=>e instanceof i.Eb,i.Eb),r=i.jh.getData(this);return{fieldConfig:null==t?void 0:t.state.fieldConfig,frames:null==r||null===(e=r.state.data)||void 0===e?void 0:e.series}}constructor(e){super(P(x({},e),{queries:[]})),k(this,"_onActivate",()=>{this._subs.add(this.subscribeToState(()=>{this.getQueries(),this.getContext()}));const e=i.jh.interpolate(this,m.gR);this.setState({dsUid:e})}),k(this,"getQueries",()=>{const e=i.jh.getData(this),t=i.jh.findObject(e,E.xT);if((0,E.xT)(t)){const e=this.state.frame?_(this.state.frame):null,r=t.state.queries.map(r=>P(x({},r),{expr:i.jh.interpolate(t,r.expr),legendFormat:(null==e?void 0:e.name)?`{{ ${e.name} }}`:i.jh.interpolate(t,r.legendFormat)}));JSON.stringify(r)!==JSON.stringify(this.state.queries)&&this.setState({queries:r})}}),k(this,"updateFieldConfigOverrides",()=>{const{fieldConfig:e,frames:t}=this.getPanelConfigAndDataFrames();if(e&&(null==t?void 0:t.length)){for(const a of t)for(const t of a.fields){const a=Object.keys(t.config).map(e=>({id:e,value:t.config[e]})),i=e.overrides.find(e=>{var r,n;return e.matcher.options===(null!==(n=null!==(r=t.config.displayNameFromDS)&&void 0!==r?r:t.config.displayName)&&void 0!==n?n:t.name)&&"byName"===e.matcher.id});var r,n;if(!i)e.overrides.unshift({matcher:{id:"byName",options:null!==(n=null!==(r=t.config.displayNameFromDS)&&void 0!==r?r:t.config.displayName)&&void 0!==n?n:t.name},properties:a});i&&JSON.stringify(i.properties)!==JSON.stringify(a)&&(i.properties=a)}return e}}),k(this,"getContext",()=>{const e=this.updateFieldConfigOverrides(),{queries:t,dsUid:r,labelName:n,fieldName:a}=this.state,o=i.jh.getTimeRange(this);if(!o||!t||!r)return;const s={origin:"Metrics Drilldown",type:"timeseries",queries:t,timeRange:x({},o.state.value),datasource:{uid:r},url:window.location.href,id:`${JSON.stringify(t)}${n}${a}`,title:n+(a?` > ${a}`:""),logoPath:w,drillDownLabel:a,fieldConfig:e};JSON.stringify(s)!==JSON.stringify(this.state.context)&&this.setState({context:s})}),this.addActivationHandler(this._onActivate.bind(this))}}k(C,"Component",({model:e})=>{const{context:t}=e.useState(),{links:r}=(0,a.usePluginLinks)({extensionPointId:j,context:t,limitPerPlugin:1}),n=r.find(e=>"grafana-investigations-app"===e.pluginId);return n?l().createElement(o.IconButton,{tooltip:n.description,"aria-label":"add panel to exploration",key:n.id,name:null!==(i=n.icon)&&void 0!==i?i:"panel-add",onClick:e=>{n.onClick&&n.onClick(e)}}):null;var i});const _=e=>{var t,r;const n=null!==(r=null===(t=e.fields[1])||void 0===t?void 0:t.labels)&&void 0!==r?r:{},a=Object.keys(n);if(1!==a.length)return;const i=a[0];return{name:i,value:n[i]}};function L(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function N(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){L(i,n,a,o,s,"next",e)}function s(e){L(i,n,a,o,s,"throw",e)}o(void 0)})}}function D(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function A(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){D(e,t,r[t])})}return e}function B(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const T="Add to investigation",$="investigations_divider",M="Investigations";class I extends i.Bs{addItem(e){this.state.body&&this.state.body.addItem(e)}setItems(e){this.state.body&&this.state.body.setItems(e)}constructor(e){var t,r;super(B(A({},e),{addExplorationsLink:null===(r=e.addExplorationsLink)||void 0===r||r})),(t=this).addActivationHandler(()=>{let e;try{const n=i.jh.getAncestor(t,i.Eb),a=i.jh.getData(n).state.data;if(!a)throw new Error("Cannot get link to explore, no panel data found");const o=(0,E.un)(n);var r;(null!==(r=null==o?void 0:o.state.queries)&&void 0!==r?r:[]).forEach(e=>{delete e.legendFormat}),e=(0,i.pN)(a,t,a.timeRange,e=>"expr"in e&&"string"==typeof e.expr&&e.expr.includes("__ignore_usage__")?B(A({},e),{expr:e.expr.replace(/,?__ignore_usage__=""/,"")}):e)}catch(e){}const n=[{text:"Navigation",type:"group"},{text:"Explore",iconClassName:"compass",onClick:()=>null==e?void 0:e.then(e=>e&&window.open(e,"_blank")),shortcut:"p x"}];t.setState({body:new i.Lw({items:n})});const a=new C({labelName:t.state.labelName,fieldName:t.state.fieldName,frame:t.state.frame});var o;(t._subs.add(null==a?void 0:a.subscribeToState(()=>N(function*(){var e;yield(e=t,N(function*(){const t=e.state.explorationsButton;if(t){var r;const l=yield R(t);var n;const c=null!==(n=null===(r=e.state.body)||void 0===r?void 0:r.state.items)&&void 0!==n?n:[],u=c.find(e=>e.text===T);var a,i,o,s;l&&(u?u&&(null===(a=e.state.body)||void 0===a||a.setItems(c.filter(e=>!1===[$,M,T].includes(e.text)))):(null===(i=e.state.body)||void 0===i||i.addItem({text:$,type:"divider"}),null===(o=e.state.body)||void 0===o||o.addItem({text:M,type:"group"}),null===(s=e.state.body)||void 0===s||s.addItem({text:T,iconClassName:"plus-square",onClick:e=>l.onClick&&l.onClick(e)})))}})())})())),t.setState({explorationsButton:a}),t.state.addExplorationsLink)&&(null===(o=t.state.explorationsButton)||void 0===o||o.activate())})}}D(I,"Component",({model:e})=>{const{body:t}=e.useState();return t?l().createElement(t.Component,{model:t}):l().createElement(l().Fragment,null)});const R=e=>N(function*(){const t=e.state.context;if(a.config.buildInfo.version.startsWith("11."))try{const e=(yield Promise.resolve().then(r.t.bind(r,8531,23))).getPluginLinkExtensions;if(void 0!==e){return e({extensionPointId:j,context:t}).extensions[0]}}catch(e){v.v.error(e,{message:"Error importing getPluginLinkExtensions"})}if("function"==typeof a.getObservablePluginLinks){return(yield(0,y.firstValueFrom)((0,a.getObservablePluginLinks)({extensionPointId:j,context:t})))[0]}})();class F extends i.Bs{_onActivate(){const{autoQuery:e}=(0,S.aM)(this).state;0!==e.variants.length&&this.setState({options:e.variants.map(e=>({label:e.variant,value:e.variant}))})}constructor(e){super(e),this.addActivationHandler(this._onActivate.bind(this))}}function V(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function H(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(F,"Component",({model:e})=>{const{options:t,onChangeQuery:r,queryDef:n}=e.useState();return t?l().createElement(o.RadioButtonGroup,{size:"sm",options:t,value:n.variant,onChange:r}):null});class z extends i.Bs{onActivate(){if(!this.state.panel){const{autoQuery:e,metric:t}=(0,S.aM)(this).state;this.getVizPanelFor(e.main,t).then(e=>this.setState({panel:e,metric:t}))}}getVizPanelFor(e,t){return(r=function*(){const r=(0,S.kj)(this),n=yield r.getMetricMetadata(t),a=(0,g.R)(n);return e.vizBuilder().setData(new i.dt({datasource:m.GH,maxDataPoints:m.dc,queries:e.queries})).setDescription(a).setHeaderActions([new F({queryDef:e,onChangeQuery:this.onChangeQuery})]).setShowMenuAlways(!0).setMenu(new I({labelName:null!=t?t:this.state.metric})).build()},function(){var e=this,t=arguments;return new Promise(function(n,a){var i=r.apply(e,t);function o(e){V(i,n,a,o,s,"next",e)}function s(e){V(i,n,a,o,s,"throw",e)}o(void 0)})}).call(this);var r}constructor(e){super(e),H(this,"onChangeQuery",e=>{const t=(0,S.aM)(this),r=t.state.autoQuery.variants.find(t=>t.variant===e);this.getVizPanelFor(r).then(e=>this.setState({panel:e})),t.setState({queryDef:r})}),this.addActivationHandler(this.onActivate.bind(this))}}H(z,"Component",({model:e})=>{const{panel:t}=e.useState();if(t)return l().createElement(t.Component,{model:t})});const U={OPEN_EXPLORE_LABEL:"Open in explore",COPY_URL_LABEL:"Copy url",BOOKMARK_LABEL:"Bookmark",SELECT_NEW_METRIC_TOOLTIP:"Remove existing metric and choose a new metric"};var q=r(7818),G=r(7781),Q=r(7019);function W(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const K="metric-graph";class Y extends i.Bs{constructor(e){var t;super(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){W(e,t,r[t])})}return e}({topView:null!==(t=e.topView)&&void 0!==t?t:new i.G1({direction:"column",$behaviors:[new i.Gg.K2({key:"metricCrosshairSync",sync:G.DashboardCursorSync.Crosshair})],children:[new i.vA({minHeight:280,maxHeight:"40%",body:new z({key:K})}),new i.vA({ySizing:"content",body:new Kt({})})]})},e))}}function J(e,t,r){return{container:(0,n.css)({display:"flex",flexDirection:"column",position:"relative",flexGrow:1}),sticky:(0,n.css)({display:"flex",flexDirection:"row",background:(0,Q.T)(e,r),position:"sticky",paddingTop:e.spacing(1),marginTop:`-${e.spacing(1)}`,zIndex:10,top:`calc(var(--app-controls-height, 0px) + ${t}px)`}),nonSticky:(0,n.css)({display:"flex",flexDirection:"row"})}}W(Y,"Component",({model:e})=>{const{topView:t,selectedTab:r}=e.useState(),{stickyMainGraph:n}=(0,S.KE)(e).useState(),i=(0,a.useChromeHeaderHeight)(),s=(0,S.kj)(e),c=(0,o.useStyles2)(J,s.state.embedded?0:null!=i?i:0,s);return l().createElement("div",{className:c.container},l().createElement("div",{className:n?c.sticky:c.nonSticky,"data-testid":"top-view"},l().createElement(t.Component,{model:t})),r&&l().createElement("div",{"data-testid":"tab-content"},l().createElement(r.Component,{model:r})))});var Z=r(1816),X=r(7238),ee=r(5635),te=r(697),re=r(6920),ne=r(7397),ae=r(9585),ie=r(5568),oe=r(5036),se=r(6096),le=r(28),ce=r(8156),ue=r(9966),de=r(8628),pe=r(3831);function me(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function he(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const be={label:"All metric names",value:"all"};class fe extends i.Bs{getUrlState(){return{metricPrefix:this.state.value}}updateFromUrl(e){"string"!=typeof e.metricPrefix?this.setState({value:be.value}):this.state.value!==e.metricPrefix&&this.setState({value:e.metricPrefix})}onActivate(){this.parseMetricPrefixes()}parseMetricPrefixes(){if(this._variableDependency.hasDependencyInLoadingState())return void this.setState({error:void 0,loading:!0});const e=i.jh.lookupVariable(ie.$,this);if(e.state.error)return void this.setState({error:e.state.error,loading:!1,options:[]});const t=(0,de.w)((0,pe.a)(e)),r=[be,...t.map(e=>({value:e.value,label:`${e.label} (${e.count})`}))],{value:n}=this.state,a=r.find(e=>e.value===n)?n:be.value;this.setState({error:null,loading:!1,options:r}),this.selectOption({value:a,label:a})}constructor(e){super(he(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){me(e,t,r[t])})}return e}({},e),{key:"related-prefix-filter",loading:!0,error:null,options:[be],value:be.value})),me(this,"_variableDependency",new i.Sh(this,{variableNames:[ie.$],onVariableUpdateCompleted:()=>this.parseMetricPrefixes()})),me(this,"_urlSync",new i.So(this,{keys:["metricPrefix"]})),me(this,"selectOption",e=>{const t=null===e?be.value:e.value;this.setState({value:t}),this.publishEvent(new le.Y({type:"prefixes",filters:t===be.value?[]:[t]}),!0)}),this.addActivationHandler(this.onActivate.bind(this))}}function ge(e){return{container:n.css`
      display: flex;

      & > div {
        margin: 0;
      }
    `,label:n.css`
      margin-right: 0;
      background-color: ${e.colors.background.primary};
      border: 1px solid ${e.colors.border.medium};
      border-right: 0 none;
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    `,tooltipIcon:n.css`
      margin-left: ${e.spacing(.5)};
    `}}function ye(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ve(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}me(fe,"Component",({model:e})=>{const t=(0,o.useStyles2)(ge),{loading:r,options:n,value:a,error:i}=e.useState();return l().createElement("div",{className:t.container,"data-testid":"prefix-filter-selector"},l().createElement(o.InlineField,{disabled:r,error:i&&i.toString(),label:l().createElement(o.InlineLabel,{width:"auto",className:t.label},l().createElement("span",null,"View by"),l().createElement(o.Tooltip,{content:"View by the metric prefix. A metric prefix is a single word at the beginning of the metric name, relevant to the domain the metric belongs to.",placement:"top"},l().createElement(o.Icon,{className:t.tooltipIcon,name:"info-circle",size:"sm"})))},l().createElement(o.Combobox,{value:a,onChange:e.selectOption,options:n})))});class we extends i.P1{constructor(e){super(ve(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){ye(e,t,r[t])})}return e}({},e),{key:"related-list-controls",body:new i.G1({direction:"row",width:"100%",maxHeight:"32px",children:[new i.vA({width:"auto",body:new fe({})}),new i.vA({body:new X.I({urlSearchParamName:"gmd-relatedSearchText",targetName:"related metric",countsProvider:new ue.s,displayCounts:!0})}),new i.vA({width:"auto",body:new ce.U({})})]})}))}}function Se(){return{headerWrapper:(0,n.css)({display:"flex",alignItems:"center","& > div":{display:"flex",alignItems:"center","& > div":{display:"flex",alignItems:"center"}}})}}ye(we,"Component",({model:e})=>{const t=(0,o.useStyles2)(Se),{body:r}=e.useState();return l().createElement("div",{className:t.headerWrapper,"data-testid":"related-list-controls"},l().createElement(r.Component,{model:r}))});class Oe extends i.Bs{onActivate(){this.subscribeToEvents()}subscribeToEvents(){this.initVariablesFilteringAndSorting()}initVariablesFilteringAndSorting(){const{metric:e}=this.state,t=new Map;this._subs.add(this.subscribeToEvent(te.x,e=>{const{key:r}=e.payload,n=i.jh.findByKey(this,r);t.set(r,{filterEngine:new oe.k(n),sortEngine:new se.c(n)})})),this._subs.add(this.subscribeToEvent(re.e,e=>{t.delete(e.payload.key)}));const r=i.jh.findByKeyAndType(this,"quick-search",X.I);this._subs.add(this.subscribeToEvent(ne.x,n=>{const{key:a,options:i}=n.payload,{filterEngine:o,sortEngine:s}=t.get(a);o.setInitOptions(i);const l={names:r.state.value?[r.state.value]:[]};o.applyFilters(l,{forceUpdate:!0,notify:!1}),s.sort("related",{metric:e})})),this._subs.add(this.subscribeToEvent(Z.W,r=>{const{searchText:n}=r.payload;for(const[,{filterEngine:r,sortEngine:a}]of t)r.applyFilters({names:n?[n]:[]}),a.sort("related",{metric:e})})),this._subs.add(this.subscribeToEvent(le.Y,r=>{const{type:n,filters:a}=r.payload;for(const[,{filterEngine:r,sortEngine:i}]of t)r.applyFilters({[n]:a}),i.sort("related",{metric:e})}))}constructor({metric:e}){super({metric:e,$variables:new i.Pj({variables:[new ie.s,new ae.V]}),key:"RelatedMetricsScene",body:new ee.Qs({variableName:ae.h}),listControls:new we({})}),this.addActivationHandler(this.onActivate.bind(this))}}function Ee(e){return{body:(0,n.css)({}),list:(0,n.css)({}),listControls:(0,n.css)({margin:e.spacing(1,0,1.5,0)}),variables:(0,n.css)({display:"none"})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(Oe,"Component",({model:e})=>{const t=(0,o.useStyles2)(Ee),{$variables:r,body:n,listControls:a}=e.useState();return l().createElement(l().Fragment,null,l().createElement("div",{className:t.listControls},l().createElement(a.Component,{model:a})),l().createElement("div",{className:t.body},l().createElement("div",{className:t.list,"data-testid":"panels-list"},l().createElement(n.Component,{model:n}))),l().createElement("div",{className:t.variables},null==r?void 0:r.state.variables.map(e=>l().createElement(e.Component,{key:e.state.name,model:e}))))});var ke=r(4137);const xe=U.COPY_URL_LABEL,Pe=({trail:e})=>{const[t,r]=(0,s.useState)(xe);return l().createElement(o.ToolbarButton,{variant:"canvas",icon:"share-alt",tooltip:t,onClick:()=>{if(navigator.clipboard){(0,c.z)("selected_metric_action_clicked",{action:"share_url"});const t=`${a.config.appUrl.endsWith("/")?a.config.appUrl.slice(0,-1):a.config.appUrl}${ke.Gy}/${(0,S.xi)(e)}`;navigator.clipboard.writeText(t),r("Copied!"),setTimeout(()=>{r(xe)},2e3)}}})};var je=r(2425);var Ce=r(1932),_e=r(6503),Le=r(7437);const Ne=`${m.Rp}{${m.ui}}`,De=`rate(${Ne}[$__rate_interval])`,Ae=`{"${m.Rp}", ${m.ui}}`,Be=`rate(${Ae}[$__rate_interval])`;function Te({isRateQuery:e=!1,groupings:t=[],isUtf8Metric:r=!1}){let n;return n=r?e?Be:Ae:e?De:Ne,t.length>0?`sum by(${t.join(", ")}) (${n})`:`${n}`}var $e=r(1625),Me=r(5938);function Ie({title:e,unit:t}){return i.d0.timeseries().setTitle(e).setUnit(t).setOption("legend",{showLegend:!1}).setOption("tooltip",{mode:$e.$N.Multi,sort:$e.xB.Descending}).setCustomFieldConfig("fillOpacity",9)}function Re(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Fe(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Re(e,t,r[t])})}return e}function Ve(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function He({description:e,mainQueryExpr:t,breakdownQueryExpr:r,unit:n}){const a={title:m.Rp,unit:n},i={refId:"A",expr:t,legendFormat:e,fromExploreMetrics:!0},o=Ve(Fe({},a),{title:e,queries:[i],variant:"main",vizBuilder:()=>Ie(Fe({},o))}),s=Ve(Fe({},a),{queries:[Ve(Fe({},i),{legendFormat:e})],vizBuilder:()=>Ie(s),variant:"preview"}),l=Ve(Fe({},a),{queries:[{refId:"A",expr:r,legendFormat:`{{${m.aZ}}}`,fromExploreMetrics:!0}],vizBuilder:()=>Ie(l),variant:"breakdown"});return{preview:s,main:o,breakdown:l,variants:[]}}const ze=new Set(["count","total"]),Ue={count:"sum",total:"sum"},qe={avg:"average",sum:"overall"};function Ge(e){const{metricParts:t,suffix:r,isUtf8Metric:n}=e,a="total"===r?t.at(-2):r,i=ze.has(r),o=Ue[r]||"avg",s=i?(0,Le.MM)(a):(0,Le.l_)(a),l=Te({isRateQuery:i,isUtf8Metric:n}),c=`${u=o,qe[u]||u}${i?" per-second rate":""}`;var u;return He({description:`${m.Rp} (${c})`,mainQueryExpr:`${o}(${l})`,breakdownQueryExpr:`${o}(${l})by(${m.aZ})`,unit:s})}function Qe(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function We(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Qe(e,t,r[t])})}return e}function Ke(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}function Ye(e){const{unit:t,nativeHistogram:r}=e,n={title:m.Rp,unit:t},a=Ke(We({},n),{variant:"p50",queries:[Je(e,50)],vizBuilder:()=>Ie(a)}),o=Ke(We({},n),{variant:"p50",queries:[Je(e,50,[m.aZ])],vizBuilder:()=>Ie(o)}),s=Ke(We({},n),{variant:"percentiles",queries:[99,90,50].map(t=>Je(e,t)),vizBuilder:()=>function({title:e,unit:t}){return i.d0.timeseries().setTitle(e).setUnit(t).setCustomFieldConfig("fillOpacity",9).setOption("tooltip",{mode:$e.$N.Multi,sort:$e.xB.Descending}).setOption("legend",{showLegend:!1})}(s)}),l=Ke(We({},n),{variant:"heatmap",queries:[{refId:"Heatmap",expr:Te({isRateQuery:!0,isUtf8Metric:e.isUtf8Metric,groupings:r?[]:["le"]}),fromExploreMetrics:!0,format:"heatmap"}],vizBuilder:()=>function({title:e,unit:t}){return i.d0.heatmap().setTitle(e).setUnit(t).setOption("calculate",!1).setOption("color",{mode:Me.P7.Scheme,exponent:.5,scheme:"Spectral",steps:32,reverse:!1})}(l)});return{preview:l,main:l,variants:[s,l],breakdown:o}}function Je(e,t,r=[]){const n=t/100;let a=`${t}th Percentile`;r[0]&&(a=`{{${r[0]}}}`);return{refId:`Percentile${t}`,expr:`histogram_quantile(${n}, ${Te({isRateQuery:!0,isUtf8Metric:e.isUtf8Metric,groupings:e.nativeHistogram?[...r]:["le",...r]})})`,legendFormat:a,fromExploreMetrics:!0}}function Ze(e,t){return`${e.replace(m.Rp,`${t}_sum`)}/${e.replace(m.Rp,`${t}_count`)}`}function Xe(e,t){const r=!(0,Ce.Rq)(e),n=e.split("_"),a=n.at(-1);if(null==a)throw new Error(`This function does not support a metric suffix of "${a}"`);const i=n.at(-2),o={metricParts:n,isUtf8Metric:r,suffix:a,unitSuffix:i,unit:(0,Le.l_)(i),nativeHistogram:t};return"sum"===a?function(e){const{metricParts:t,isUtf8Metric:r,unit:n}=e,a=t.slice(0,-1).join("_"),i=`${a} (average)`,o=Te({isRateQuery:!0,isUtf8Metric:r});return He({description:i,mainQueryExpr:Ze(`sum(${o})`,a),breakdownQueryExpr:Ze(`sum(${o})by(${m.aZ})`,a),unit:n})}(o):"bucket"===a||t?Ye(o):Ge(o)}var et=r(3241);class tt extends G.BusEventWithPayload{}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(tt,"type","timeseries-data-received");class rt extends G.BusEventWithPayload{}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(rt,"type","force-sync-y-axis");class nt extends G.BusEventWithPayload{}function at(){return e=>{let t=Number.NEGATIVE_INFINITY,r=Number.POSITIVE_INFINITY;const n=i.jh.getTimeRange(e).subscribeToState(()=>{t=Number.NEGATIVE_INFINITY,r=Number.POSITIVE_INFINITY}),a=e.subscribeToEvent(nt,()=>{t=Number.NEGATIVE_INFINITY,r=Number.POSITIVE_INFINITY}),o=e.subscribeToEvent(rt,()=>{let[n,a]=[t,r];const i=ot(e).filter(e=>{var t;const{fieldConfig:r,$data:i}=e.state;return(!("min"in r.defaults)||!("max"in r.defaults))&&([n,a]=it((null==i||null===(t=i.state.data)||void 0===t?void 0:t.series)||[],n,a),!0)});n===t&&a===r?st(e,t,r,i):([t,r]=[n,a],st(e,n,a))}),s=e.subscribeToEvent(tt,n=>{const[a,i]=it(n.payload.series||[],t,r);a===i||a===Number.NEGATIVE_INFINITY||i===Number.POSITIVE_INFINITY||a===t&&i===r||([t,r]=[a,i],st(e,a,i))});return()=>{s.unsubscribe(),o.unsubscribe(),a.unsubscribe(),n.unsubscribe()}}}function it(e,t,r){let[n,a]=[t,r];for(const t of e||[]){var i;const e=null===(i=t.fields[1])||void 0===i?void 0:i.values.filter(Boolean);e&&(n=Math.max(n,...e),a=Math.min(a,...e))}return[n,a]}function ot(e){return i.jh.findAllObjects(e,e=>e instanceof i.Eb&&"timeseries"===e.state.pluginId)}function st(e,t,r,n){for(const a of n||ot(e))a.clearFieldConfigCache(),a.setState({fieldConfig:(0,et.merge)((0,et.cloneDeep)(a.state.fieldConfig),{defaults:{min:r,max:t}})})}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(nt,"type","reset-sync-y-axis");var lt=r(2024);function ct(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ut extends i.Bs{constructor(...e){super(...e),ct(this,"onClick",()=>{const{label:e}=this.state;(0,c.z)("breakdown_panel_selected",{label:e});const t=i.jh.lookupVariable(m.yr,this);if(!(0,h.bA)(t))throw new Error("Group by variable not found");t.changeValueTo(e)})}}function dt(){return e=>{var t;const r=null===(t=e.state.$data)||void 0===t?void 0:t.state.data;(null==r?void 0:r.state)===G.LoadingState.Done&&e.publishEvent(new tt({series:r.series}),!0),e.state.$data.subscribeToState((t,r)=>{var n,a,i;(null===(n=t.data)||void 0===n?void 0:n.state)===G.LoadingState.Done&&(null===(a=t.data)||void 0===a?void 0:a.series)!==(null===(i=r.data)||void 0===i?void 0:i.series)&&e.publishEvent(new tt({series:t.data.series}),!0)})}}ct(ut,"Component",({model:e})=>l().createElement(o.Button,{variant:"secondary",size:"sm",fill:"outline",onClick:e.onClick},"Select"));const pt=()=>e=>e.pipe((0,y.map)(e=>null==e?void 0:e.map((e,t)=>(e.refId=`${e.refId}-${t}`,e))));function mt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ht(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const bt=e=>()=>t=>t.pipe((0,y.map)(t=>null==t?void 0:t.map(t=>{var r;return(null==t?void 0:t.fields[1])?((null===(r=t.fields[1].labels)||void 0===r?void 0:r[e])||(t.fields[1].labels=ht(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){mt(e,t,r[t])})}return e}({},t.fields[1].labels),{[e]:`<unspecified ${e}>`})),t):t})));function ft(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const gt="seriesCount",yt=(e,t)=>()=>r=>r.pipe((0,y.map)(r=>null==r?void 0:r.slice(e,t).map(e=>{var t;return e.meta=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){ft(e,t,r[t])})}return e}({},e.meta),(t=e.meta).stats||(t.stats=[]),e.meta.stats.unshift({displayName:gt,value:r.length}),e})));const vt="220px";class wt extends i.Bs{static buildVizPanel({metric:e,label:t,query:r,unit:n}){const a=new i.Es({$data:new i.dt({datasource:m.GH,maxDataPoints:m.up,queries:[{refId:`${e}-${t}`,expr:r,legendFormat:`{{${t}}}`,fromExploreMetrics:!0}]}),transformations:[yt(0,20),bt(t),pt]});return i.d0.timeseries().setTitle(t).setUnit(n).setData(a).setBehaviors([dt()]).setOption("tooltip",{mode:o.TooltipDisplayMode.Multi,sort:$e.xB.Descending}).setHeaderActions([new ut({label:t})]).setMenu(new I({labelName:t})).setShowMenuAlways(!0).build()}onActivate(){const{body:e}=this.state;this._subs.add(e.state.$data.subscribeToState(t=>{var r;if((null===(r=t.data)||void 0===r?void 0:r.state)!==G.LoadingState.Done)return;const{series:n}=t.data;if(null==n?void 0:n.length){const t=this.getAllValuesConfig(n);e.setState((0,et.merge)({},e.state,t))}}))}getAllValuesConfig(e){var t,r;const{label:n}=this.state,a=null===(r=e[0].meta)||void 0===r||null===(t=r.stats)||void 0===t?void 0:t.find(e=>e.displayName===gt),i=a?a.value:e.length;return{title:`${n} (${i})`,description:e.length<i?`Showing only ${e.length} series out of ${i} to keep the data easy to read. Click on "Select" on this panel to view a breakdown of all the label's values.`:"",fieldConfig:{overrides:this.getOverrides(e)}}}getOverrides(e){const{startColorIndex:t}=this.state;return e.map((e,r)=>({matcher:{id:G.FieldMatcherID.byFrameRefID,options:e.refId},properties:[{id:"color",value:{mode:"fixed",fixedColor:(0,S.Vy)(t+r)}}]}))}constructor({metric:e,label:t,query:r,unit:n,startColorIndex:a}){super({key:`label-viz-panel-${t}`,metric:e,label:t,query:r,unit:n,startColorIndex:a,body:wt.buildVizPanel({metric:e,label:t,query:r,unit:n})}),this.addActivationHandler(this.onActivate.bind(this))}}function St(){return{container:(0,n.css)({height:vt})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(wt,"Component",({model:e})=>{const{body:t}=e.useState(),r=(0,o.useStyles2)(St);return l().createElement("div",{className:r.container},l().createElement(t.Component,{model:t}))});class Ot extends i.Bs{onActivate(){this.subscribeToLayoutChange()}subscribeToLayoutChange(){const e=i.jh.findByKeyAndType(this,"layout-switcher",ce.U),t=this.state.body.state.body,r=(e,r)=>{e.layout!==(null==r?void 0:r.layout)&&t.setState({templateColumns:e.layout===ce.p.ROWS?ee._O:ee.MV})};i.Go.syncStateFromSearchParams(e,new URLSearchParams(window.location.search)),r(e.state),this._subs.add(e.subscribeToState(r))}Controls({model:e}){const{layoutSwitcher:t}=e.useState();return l().createElement(o.Field,{label:"View"},l().createElement(t.Component,{model:t}))}constructor({metric:e}){const t=Xe(e).breakdown,{expr:r}=t.queries[0],n=t.unit;super({key:"metric-labels-list",metric:e,layoutSwitcher:new ce.U({}),body:new pe.k({variableName:m.yr,initialPageSize:60,pageSizeIncrement:9,body:new i.gF({children:[],isLazy:!0,templateColumns:ee.MV,autoRows:vt,$behaviors:[new i.Gg.K2({key:"metricCrosshairSync",sync:G.DashboardCursorSync.Crosshair}),at()]}),getLayoutLoading:()=>new i.dM({reactNode:l().createElement(o.Spinner,{inline:!0})}),getLayoutEmpty:()=>new i.dM({reactNode:l().createElement(_e._,{title:"",severity:"info"},"No labels found for the current filters and time range.")}),getLayoutError:e=>new i.dM({reactNode:l().createElement(_e._,{severity:"error",title:"Error while loading labels!",error:e})}),getLayoutChild:(t,a)=>{const o=r.replaceAll(m.aZ,(0,Ce.Nc)(String(t.value)));return new i.xK({body:new wt({metric:e,label:t.value,query:o,unit:n,startColorIndex:a})})}})}),this.addActivationHandler(this.onActivate.bind(this))}}function Et(e){return{container:(0,n.css)({width:"100%"}),footer:(0,n.css)({display:"flex",justifyContent:"center",alignItems:"center",marginTop:e.spacing(4),"& button":{height:"40px",borderRadius:"8px"}})}}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(Ot,"Component",({model:e})=>{const{body:t}=e.useState(),r=(0,o.useStyles2)(Et),n=i.jh.lookupVariable(m.yr,e),{loading:a,error:s}=n.useState(),c=t.useSizes(),u=!a&&!s&&c.total>0&&c.current<c.total;return l().createElement("div",{"data-testid":"labels-list"},l().createElement("div",{className:r.container},l().createElement(t.Component,{model:t})),u&&l().createElement("div",{className:r.footer},l().createElement(lt.d,{label:"label",batchSizes:c,onClick:()=>{t.increaseBatchSize()}})))});var kt=r(1709);function xt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Pt extends i.Bs{constructor(...e){super(...e),xt(this,"onClick",()=>{const e=i.jh.lookupVariable(m.Ao,this);if(!(0,h.BE)(e))return;const{labelName:t,labelValue:r}=this.state;(0,c.z)("label_filter_changed",{label:t,action:"added",cause:"breakdown"}),(0,S.kj)(this).addFilterWithoutReportingInteraction({key:t,operator:"=",value:r})})}}function jt(e){var t;const r=(null===(t=e.fields[1])||void 0===t?void 0:t.labels)||{},n=Object.keys(r);return 0===n.length?"<unspecified>":r[n[0]]}xt(Pt,"Component",({model:e})=>l().createElement(o.Button,{variant:"secondary",size:"sm",fill:"outline",onClick:e.onClick},"Add to filters"));var Ct=r(3422),_t=r(619);function Lt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Nt extends i.Bs{constructor(e){const t=(r=e.target,localStorage.getItem(`${m.I1}.${r}.by`)||null);var r;super({key:"breakdown-sort-by",target:e.target,options:Nt.DEFAULT_OPTIONS,value:t&&Nt.DEFAULT_OPTIONS.find(e=>e.value===t)||Nt.DEFAULT_OPTIONS[0]}),Lt(this,"onChange",e=>{this.setState({value:e}),function(e,t){t&&localStorage.setItem(`${m.I1}.${e}.by`,`${t}`)}(this.state.target,e.value)})}}function Dt(e){return{sortByTooltip:(0,n.css)({display:"flex",gap:e.spacing(1)})}}function At(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Lt(Nt,"DEFAULT_OPTIONS",[{value:"outliers",label:"Outlying series",description:"Prioritizes values that show distinct behavior from others within the same label"},{value:"alphabetical",label:"Name [A-Z]",description:"Alphabetical order"},{value:"alphabetical-reversed",label:"Name [Z-A]",description:"Reversed alphabetical order"}]),Lt(Nt,"Component",({model:e})=>{const t=(0,o.useStyles2)(Dt),{value:r,options:n}=e.useState();return l().createElement(o.Field,{"data-testid":"sort-by-select",htmlFor:"sort-by-criteria",label:l().createElement("div",{className:t.sortByTooltip},"Sort by",l().createElement(o.IconButton,{name:"info-circle",size:"sm",variant:"secondary",tooltip:"Sorts values using standard or smart time series calculations."}))},l().createElement(o.Combobox,{id:"sort-by-criteria",placeholder:"Choose criteria",width:20,options:n,value:r,onChange:e.onChange,isClearable:!1}))});class Bt extends i.Bs{performRepeat(e){var t,r,n,a;if(e.state===G.LoadingState.Loading)return void this.setState({loadingLayout:null===(t=(r=this.state).getLayoutLoading)||void 0===t?void 0:t.call(r),errorLayout:void 0,emptyLayout:void 0,currentBatchSize:0});if(e.state===G.LoadingState.Error)return void this.setState({errorLayout:null===(n=(a=this.state).getLayoutError)||void 0===n?void 0:n.call(a,e),loadingLayout:void 0,emptyLayout:void 0,currentBatchSize:0});const i=this.filterAndSort(e.series);var o,s;if(!i.length)return void this.setState({emptyLayout:null===(o=(s=this.state).getLayoutEmpty)||void 0===o?void 0:o.call(s),errorLayout:void 0,loadingLayout:void 0,currentBatchSize:0,counts:{current:0,total:e.series.length}});this.setState({loadingLayout:void 0,errorLayout:void 0,emptyLayout:void 0,currentBatchSize:this.state.initialPageSize,counts:{current:i.length,total:e.series.length}});const l=i.slice(0,this.state.initialPageSize).map((t,r)=>this.state.getLayoutChild(e,t,r)).filter(Boolean);this.state.body.setState({children:l})}initFilterAndSort(){this.searchText=i.jh.findByKeyAndType(this,"quick-search",X.I).state.value,this.sortBy=i.jh.findByKeyAndType(this,"breakdown-sort-by",Nt).state.value.value}filterAndSort(e){let t=[];if(this.searchText){const r=this.searchText.split(",").map(e=>e.trim()).filter(Boolean).map(e=>{try{return new RegExp(e)}catch(e){return null}}).filter(Boolean);for(let n=0;n<e.length;n+=1){const a=e[n];r.some(e=>e.test(jt(a)))&&t.push(a)}}else t=e;return this.sortBy&&(t=(0,_t.sortSeries)(t,this.sortBy)),t}filter(e){this.searchText=e;const{data:t}=i.jh.getData(this).state;t&&(this.publishEvent(new nt({}),!0),this.performRepeat(t))}sort(e){this.sortBy=e;const{data:t}=i.jh.getData(this).state;t&&(this.publishEvent(new nt({}),!0),this.performRepeat(t))}increaseBatchSize(){const{data:e}=i.jh.getData(this).state;if(!e)return;const t=this.state.currentBatchSize+this.state.pageSizeIncrement,r=this.filterAndSort(e.series).slice(this.state.currentBatchSize,t).map((t,r)=>this.state.getLayoutChild(e,t,r)).filter(Boolean);this.state.body.setState({children:[...this.state.body.state.children,...r]}),this.setState({currentBatchSize:t}),this.publishEvent(new rt({}),!0)}useSizes(){const{currentBatchSize:e,pageSizeIncrement:t}=this.useState(),{data:r}=i.jh.getData(this).state,n=r?this.filterAndSort(r.series).length:0,a=n-e;return{increment:a<t?a:t,current:e,total:n}}getCounts(){const{data:e}=i.jh.getData(this).state;return{current:0,total:e?e.series.length:0}}constructor({$behaviors:e,body:t,getLayoutChild:r,getLayoutLoading:n,getLayoutError:a,getLayoutEmpty:o,initialPageSize:s,pageSizeIncrement:l}){super({key:"breakdown-by-frame-repeater",$behaviors:e,body:t,getLayoutChild:r,getLayoutLoading:n,getLayoutError:a,getLayoutEmpty:o,currentBatchSize:0,initialPageSize:s||120,pageSizeIncrement:l||9,loadingLayout:void 0,errorLayout:void 0,emptyLayout:void 0,counts:{current:0,total:0}}),At(this,"searchText",""),At(this,"sortBy",void 0),this.addActivationHandler(()=>{const e=i.jh.getData(this);if(!e)throw new Error("No data provider found!");this.initFilterAndSort(),this._subs.add(e.subscribeToState(e=>{e.data&&this.performRepeat(e.data)})),e.state.data&&this.performRepeat(e.state.data)})}}At(Bt,"Component",({model:e})=>{const{body:t,loadingLayout:r,errorLayout:n,emptyLayout:a}=e.useState();return r?l().createElement(r.Component,{model:r}):n?l().createElement(n.Component,{model:n}):a?l().createElement(a.Component,{model:a}):l().createElement(t.Component,{model:t})});class Tt extends Ct.I{constructor(){super({key:"LabelValuesCountsProvider"}),this.addActivationHandler(()=>{i.jh.findByKeyAndType(this,"breakdown-by-frame-repeater",Bt).subscribeToState((e,t)=>{e.counts!==t.counts&&this.setState({counts:e.counts})})})}}function $t(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Mt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){$t(e,t,r[t])})}return e}function It(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}class Rt extends i.Bs{onActivate(){this.subscribeToLayoutChange()}subscribeToQuickSearchChange(){i.Go.syncStateFromSearchParams(this.state.quickSearch,new URLSearchParams(window.location.search)),this._subs.add(this.subscribeToEvent(Z.W,e=>{const t=i.jh.findDescendents(this,Bt)[0];t&&t.filter(e.payload.searchText)}))}subscribeToSortByChange(){const{sortBySelector:e}=this.state;this._subs.add(e.subscribeToState((e,t)=>{if(e.value.value!==(null==t?void 0:t.value.value)){const t=i.jh.findDescendents(this,Bt)[0];t&&t.sort(e.value.value)}}))}subscribeToLayoutChange(){const{layoutSwitcher:e}=this.state;i.Go.syncStateFromSearchParams(e,new URLSearchParams(window.location.search));const t=(e,t)=>{e.layout!==(null==t?void 0:t.layout)&&this.updateBody(e.layout)};t(e.state),this._subs.add(e.subscribeToState(t))}updateBody(e){if(e===ce.p.SINGLE)return void this.setState({body:this.buildSinglePanel()});const t=i.jh.findDescendents(this,Bt)[0],r=t||this.buildByFrameRepeater();r.state.body.setState({templateColumns:e===ce.p.ROWS?ee._O:ee.MV}),this.setState({body:r}),t||(this.subscribeToQuickSearchChange(),this.subscribeToSortByChange())}buildSinglePanel(){const{metric:e}=this.state,t=Xe(e).breakdown.unit;return i.d0.timeseries().setOption("tooltip",{mode:o.TooltipDisplayMode.Multi,sort:$e.xB.Descending}).setOption("legend",{showLegend:!0,placement:"right"}).setUnit(t).setTitle(e).build()}buildByFrameRepeater(){const{metric:e,label:t}=this.state,r=Xe(e).breakdown,n=r.unit;return new Bt({$behaviors:[at(),new i.Gg.K2({key:"metricCrosshairSync",sync:G.DashboardCursorSync.Crosshair})],body:new i.gF({children:[],isLazy:!0,templateColumns:ee.MV,autoRows:kt.tw}),getLayoutLoading:()=>new i.dM({reactNode:l().createElement(o.Spinner,{inline:!0})}),getLayoutEmpty:()=>new i.dM({reactNode:l().createElement(_e._,{title:"",severity:"info"},"No label values found for the current filters and time range.")}),getLayoutError:e=>new i.dM({reactNode:l().createElement(_e._,{severity:"error",title:"Error while loading metrics!",error:e.errors[0]})}),getLayoutChild:(a,o,s)=>{if(o.length<2)return null;const l=jt(o),c=`panel-${e}-${l}`,u=!l.startsWith("<unspecified")?[new Pt({labelName:t,labelValue:l})]:[],d=r.vizBuilder().setTitle(l).setData(new i.Zv({data:It(Mt({},a),{series:[o]})})).setBehaviors([dt()]).setColor({mode:"fixed",fixedColor:(0,S.Vy)(s)}).setHeaderActions(u).setShowMenuAlways(!0).setMenu(new I({labelName:l})).setUnit(n).build();return d.setState({key:c}),new i.xK({body:d})}})}Controls({model:e}){const t=(0,o.useStyles2)(Ft),{body:r,quickSearch:n,layoutSwitcher:a,sortBySelector:i}=e.useState();return l().createElement(l().Fragment,null,r instanceof Bt&&l().createElement(l().Fragment,null,l().createElement(o.Field,{className:t.quickSearchField,label:"Search"},l().createElement(n.Component,{model:n})),l().createElement(i.Component,{model:i})),l().createElement(o.Field,{label:"View"},l().createElement(a.Component,{model:a})))}constructor({metric:e,label:t}){super({key:"metric-label-values-list",metric:e,label:t,$data:new i.Es({$data:new i.dt({datasource:m.GH,maxDataPoints:m.up,queries:Xe(e).breakdown.queries}),transformations:[bt(t)]}),layoutSwitcher:new ce.U({urlSearchParamName:"breakdownLayout",options:[{label:"Single",value:ce.p.SINGLE},{label:"Grid",value:ce.p.GRID},{label:"Rows",value:ce.p.ROWS}]}),quickSearch:new X.I({urlSearchParamName:"breakdownSearchText",targetName:"label value",countsProvider:new Tt,displayCounts:!0}),sortBySelector:new Nt({target:"labels"}),body:void 0}),this.addActivationHandler(this.onActivate.bind(this))}}function Ft(e){return{singlePanelContainer:(0,n.css)({width:"100%",height:"300px"}),listContainer:(0,n.css)({width:"100%"}),listFooter:(0,n.css)({display:"flex",justifyContent:"center",alignItems:"center",marginTop:e.spacing(4),"& button":{height:"40px",borderRadius:"8px"}}),quickSearchField:(0,n.css)({flexGrow:1})}}$t(Rt,"Component",({model:e})=>{const{body:t}=e.useState();return l().createElement(l().Fragment,null,t instanceof i.Eb&&l().createElement(Rt.SingleMetricPanelComponent,{model:e}),t instanceof Bt&&l().createElement(Rt.ByFrameRepeaterComponent,{model:e}))}),$t(Rt,"SingleMetricPanelComponent",({model:e})=>{const t=(0,o.useStyles2)(Ft),{body:r}=e.useState();return l().createElement("div",{"data-testid":"single-metric-panel"},l().createElement("div",{className:t.singlePanelContainer},r instanceof i.Eb&&l().createElement(r.Component,{model:r})))}),$t(Rt,"ByFrameRepeaterComponent",({model:e})=>{const t=(0,o.useStyles2)(Ft),{body:r}=e.useState(),n=i.jh.getData(e),{state:a,errors:s}=n.useState().data||{},c=r,u=c.useSizes(),d=a!==G.LoadingState.Loading&&!(null==s?void 0:s.length)&&u.total>0&&u.current<u.total;return l().createElement("div",{"data-testid":"label-values-list"},l().createElement("div",{className:t.listContainer},r instanceof Bt&&l().createElement(r.Component,{model:r})),d&&l().createElement("div",{className:t.listFooter},l().createElement(lt.d,{label:"label value",batchSizes:u,onClick:()=>{c.increaseBatchSize()}})))});class Vt extends i.Bs{onActivate(){const e=this.getVariable();e.subscribeToState((t,r)=>{t.value!==r.value&&this.updateBody(e)}),a.config.featureToggles.enableScopesInMetricsExplore&&this._subs.add(this.subscribeToEvent(m.H0,()=>{this.updateBody(e)})),this.updateBody(e)}getVariable(){const e=i.jh.lookupVariable(m.yr,this);if(!(0,h.bA)(e))throw new Error("Group by variable not found");return e}updateBody(e){const{metric:t}=this.state;this.setState({body:e.hasAllValue()?new Ot({metric:t}):new Rt({metric:t,label:e.state.value})})}constructor({metric:e}){super({metric:e,body:void 0}),this.addActivationHandler(this.onActivate.bind(this))}}function Ht(e){return{container:(0,n.css)({flexGrow:1,display:"flex",minHeight:"100%",flexDirection:"column",paddingTop:e.spacing(1)}),controls:(0,n.css)({flexGrow:0,display:"flex",gap:e.spacing(2),height:"70px",justifyContent:"space-between",alignItems:"end"}),searchField:(0,n.css)({flexGrow:1})}}function zt(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function Ut(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){zt(i,n,a,o,s,"next",e)}function s(e){zt(i,n,a,o,s,"throw",e)}o(void 0)})}}function qt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(Vt,"Component",({model:e})=>{const t=(0,o.useStyles2)(Ht),{body:r}=e.useState(),n=e.getVariable();return l().createElement("div",{className:t.container},l().createElement("div",{className:t.controls},l().createElement(o.Field,{label:"By label"},l().createElement(n.Component,{model:n})),r instanceof Ot&&l().createElement(r.Controls,{model:r}),r instanceof Rt&&l().createElement(r.Controls,{model:r})),l().createElement("div",{"data-testid":"panels-list"},r instanceof Ot&&l().createElement(r.Component,{model:r}),r instanceof Rt&&l().createElement(r.Component,{model:r})))});const Gt="breakdown",Qt="logs",Wt=[{displayName:"Breakdown",value:Gt,getScene:e=>new Vt({metric:e.state.metric})},{displayName:"Related metrics",value:"related",getScene:e=>new Oe({metric:e.state.metric}),description:"Relevant metrics based on current label filters"},{displayName:"Related logs",value:Qt,getScene:e=>e.createRelatedLogsScene(),description:"Relevant logs based on current label filters and time range"}];class Kt extends i.Bs{constructor(...e){var t;super(...e),qt(t=this,"getLinkToExplore",()=>Ut(function*(){const e=i.jh.getAncestor(t,Or),r=i.jh.findByKeyAndType(t,K,z),n=void 0!==r.state.panel?i.jh.getData(r.state.panel).state.data:void 0;if(!n)throw new Error("Cannot get link to explore, no panel data found");return(0,i.pN)(n,e,n.timeRange)})()),qt(t,"openExploreLink",()=>Ut(function*(){(0,c.z)("selected_metric_action_clicked",{action:"open_in_explore"}),t.getLinkToExplore().then(e=>{window.open(e,"_blank")})})())}}function Yt(e){return{actions:(0,n.css)({[e.breakpoints.up(e.breakpoints.values.md)]:{position:"absolute",right:0,top:16,zIndex:2}}),customTabsBar:(0,n.css)({paddingBottom:e.spacing(1)})}}qt(Kt,"Component",({model:e})=>{const t=i.jh.getAncestor(e,Or),r=(0,o.useStyles2)(Yt),n=(0,S.kj)(e),[a,u]=function(e){const t=()=>(0,je._r)().getBookmarkIndex(e),r=t(),[n,a]=(0,s.useState)(r);(0,s.useEffect)(()=>{const t=e.subscribeToEvent(i.bZ,()=>{a((0,je._r)().getBookmarkIndex(e))});return()=>t.unsubscribe()},[e]),r!==n&&a(r);const o=null!=n;return[o,()=>{if((0,c.z)("bookmark_changed",{action:o?"toggled_off":"toggled_on"}),o){let e=t();for(;null!=e;)(0,je._r)().removeBookmark(e),e=t()}else(0,je._r)().addBookmark(e);a(t())}]}(n),{actionView:d}=t.useState();return l().createElement(o.Box,{paddingY:1,"data-testid":"action-bar"},l().createElement("div",{className:r.actions},l().createElement(o.Stack,{gap:1},n.state.embedded?l().createElement(o.LinkButton,{href:(0,q.Rk)((0,S.xi)(n)),variant:"secondary",icon:"arrow-right",tooltip:"Open in Metrics Drilldown",onClick:()=>(0,c.z)("selected_metric_action_clicked",{action:"open_from_embedded"})},"Metrics Drilldown"):l().createElement(o.ToolbarButton,{variant:"canvas",tooltip:U.SELECT_NEW_METRIC_TOOLTIP,onClick:()=>{(0,c.z)("selected_metric_action_clicked",{action:"unselect"}),n.publishEvent(new m.OO(void 0))}},"Select new metric"),l().createElement(o.ToolbarButton,{variant:"canvas",icon:"compass",tooltip:U.OPEN_EXPLORE_LABEL,onClick:e.openExploreLink}),l().createElement(Pe,{trail:n}),l().createElement(o.ToolbarButton,{variant:"canvas",icon:a?l().createElement(o.Icon,{name:"favorite",type:"mono",size:"lg"}):l().createElement(o.Icon,{name:"star",type:"default",size:"lg"}),tooltip:U.BOOKMARK_LABEL,onClick:u}))),l().createElement(o.TabsBar,{className:r.customTabsBar},Wt.map((e,r)=>{const n=e.displayName,a=e.value===Qt?t.state.relatedLogsCount:void 0,i=d===e.value,s=l().createElement(o.Tab,{key:r,label:n,counter:a,active:i,onChangeTab:()=>{i||((0,c.z)("metric_action_view_changed",{view:e.value,related_logs_count:t.relatedLogsOrchestrator.checkConditionsMetForRelatedLogs()?a:void 0}),t.setActionView(e.value))}});return e.description?l().createElement(o.Tooltip,{key:r,content:e.description,placement:"top",theme:"info"},s):s})))});var Jt=r(7476);function Zt(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function Xt(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){Zt(i,n,a,o,s,"next",e)}function s(e){Zt(i,n,a,o,s,"throw",e)}o(void 0)})}}const er={job:"service_name",instance:"service_instance_id"};function tr(e){return e in er?er[e]:e}const rr=e=>{let t=!1;return{name:"labelsCrossReference",checkConditionsMetForRelatedLogs:()=>t,getDataSources:()=>Xt(function*(){var r;const n=(0,S.kj)(e),o=i.jh.lookupVariable(m.Ao,n);if(!(0,h.BE)(o)||!o.state.filters.length)return t=!1,[];t=!0;const s=o.state.filters.map(({key:e,operator:t,value:r})=>({key:e,operator:t,value:r})),l=null===(r=e.state.$timeRange)||void 0===r?void 0:r.state.value,c=yield(0,Jt.tS)().getHealthyDataSources("loki"),u=yield Promise.all(c.map(({uid:e,name:t})=>Xt(function*(){const r=yield function(e,t,r){return Xt(function*(){var n;const i=yield(0,a.getDataSourceSrv)().get(e),o=yield null===(n=i.getTagKeys)||void 0===n?void 0:n.call(i,{timeRange:r,filters:t.map(({key:e,operator:t,value:r})=>({key:tr(e),operator:t,value:r}))});if(!Array.isArray(o))return!1;const s=new Set(o.map(e=>e.text));return!!t.map(e=>tr(e.key)).every(e=>s.has(e))&&(yield Promise.all(t.map(e=>Xt(function*(){var n;const a=tr(e.key),o=yield null===(n=i.getTagValues)||void 0===n?void 0:n.call(i,{key:a,timeRange:r,filters:t});return!!Array.isArray(o)&&o.some(t=>t.text===e.value)})()))).every(Boolean)})()}(e,s,l);return r?{uid:e,name:t}:null})()));return u.filter(e=>null!==e)})(),getLokiQueryExpr(){const t=(0,S.kj)(e),r=i.jh.lookupVariable(m.Ao,t);if(!(0,h.BE)(r)||!r.state.filters.length)return"";return`{${r.state.filters.map(e=>`${tr(e.key)}${e.operator}"${e.value}"`).join(",")}}`}}};var nr=r(6365);function ar(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function ir(e){return function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){ar(i,n,a,o,s,"next",e)}function s(e){ar(i,n,a,o,s,"throw",e)}o(void 0)})}}function or(e,t,r){if(!t||!r[t])return"";const n=r[t].find(t=>t.name===e);if(!n)return"";return function(e){if(function(e){if(e.trim().length<=2)return!1;let t=!1;const r=nr.K3.parse(e);return r.iterate({enter:({type:e})=>{if(e.id===nr.Yw)return t=!0,!1}}),!t}(e))return e;const t=cr(e,nr.MD);if(!t)return"";const r=e.substring(t.from,t.to),n=cr(e,nr.AL),a=n?e.substring(n.from,n.to):"";return`${r} ${a}`.trim()}(n.query)}function sr(){return ir(function*(){const e=yield(0,Jt.tS)().getHealthyDataSources("loki"),t={};return yield Promise.all(e.map(e=>ir(function*(){try{const n=function(e,t){if(0===e.length)return[];const r=new Map;return e.forEach(e=>{e.rules.filter(e=>"recording"===e.type).forEach(({type:e,name:n,query:a})=>{if(r.has(n)){const e=r.get(n);e&&(e.hasMultipleOccurrences=!0,r.set(n,e))}else r.set(n,{type:e,name:n,query:a,datasource:{name:t.name,uid:t.uid},hasMultipleOccurrences:!1})})}),Array.from(r.values())}(yield(r=e,ir(function*(){const e={url:`api/prometheus/${r.uid}/api/v1/rules`,showErrorAlert:!1,showSuccessAlert:!1},t=yield(0,y.lastValueFrom)((0,a.getBackendSrv)().fetch(e));return t.ok?t.data.data.groups:(v.v.warn(`Failed to fetch recording rules from Loki data source: ${r.name}`),[])})()),e);t[e.uid]=n}catch(e){v.v.warn(e)}var r})())),t})()}const lr=()=>{let e={},t=!1;return{name:"lokiRecordingRules",checkConditionsMetForRelatedLogs:()=>t,getDataSources:r=>ir(function*(){e=yield sr();const n=function(e,t){const r=[];return Object.values(t).forEach(t=>{t.filter(t=>t.name===e).forEach(e=>{r.push(e.datasource)})}),r}(r,e);return t=Boolean(n.length),n})(),getLokiQueryExpr:(t,r)=>or(t,r,e)}};function cr(e,t){let r;return nr.K3.parse(e).iterate({enter:e=>{if(e.type.id===t)return r=e.node,!1}}),r}function ur(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function dr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class pr{get lokiDataSources(){return this._internalState.lokiDataSources}set lokiDataSources(e){const t=this._internalState.lokiDataSources.map(e=>e.uid).join(","),r=e.map(e=>e.uid).join(",");t&&t===r||(this._internalState.lokiDataSources=e,this._changeHandlers.lokiDataSources.forEach(e=>e(this._internalState.lokiDataSources)))}set relatedLogsCount(e){this._internalState.relatedLogsCount=e,this._changeHandlers.relatedLogsCount.forEach(e=>e(this._internalState.relatedLogsCount))}addLokiDataSourcesChangeHandler(e){this._changeHandlers.lokiDataSources.push(e)}addRelatedLogsCountChangeHandler(e){this._changeHandlers.relatedLogsCount.push(e)}handleFiltersChange(){this.lokiDataSources&&(this.lokiDataSources=[],this.relatedLogsCount=0,this.findAndCheckAllDatasources())}findAndCheckAllDatasources(){return(e=function*(){const e=yield this._dataSourceFetcher.getHealthyDataSources("loki");e.length>0?this.checkLogsInDataSources(e):(this.lokiDataSources=[],this.relatedLogsCount=0)},function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){ur(i,n,a,o,s,"next",e)}function s(e){ur(i,n,a,o,s,"throw",e)}o(void 0)})}).call(this);var e}getLokiQueries(e,t=100){const{metric:r}=this._metricScene.state,n=this._logsConnectors.reduce((t,n,a)=>{const i=n.getLokiQueryExpr(r,e);var o;i&&(t[null!==(o=n.name)&&void 0!==o?o:`connector-${a}`]=i);return t},{});return Object.keys(n).map(e=>({refId:`RelatedLogs-${e}`,expr:n[e],maxLines:t,supportingQueryType:O.id}))}checkLogsInDataSources(e){const t=[];let r=0,n=0;if(0===e.length)return this.lokiDataSources=[],void(this.relatedLogsCount=0);e.forEach(a=>{const o=new i.dt({datasource:{uid:a.uid},queries:[],key:`related_logs_check_${a.uid}`});o.setState({queries:this.getLokiQueries(a.uid)}),o.subscribeToState(i=>{var o;if((null===(o=i.data)||void 0===o?void 0:o.state)===G.LoadingState.Done){var s;if(n++,null===(s=i.data)||void 0===s?void 0:s.series){const e=this.countLogsLines(i);e>0&&(t.push(a),r+=e)}n===e.length&&(this.lokiDataSources=t,this.relatedLogsCount=r)}}),o.activate()})}checkConditionsMetForRelatedLogs(){return this._logsConnectors.some(e=>e.checkConditionsMetForRelatedLogs())}countLogsLines(e){var t,r;return null!==(r=null===(t=e.data)||void 0===t?void 0:t.series.reduce((e,t)=>e+t.length,0))&&void 0!==r?r:0}constructor(e){dr(this,"_logsConnectors",void 0),dr(this,"_metricScene",void 0),dr(this,"_dataSourceFetcher",(0,Jt.tS)()),dr(this,"_changeHandlers",{lokiDataSources:[],relatedLogsCount:[]}),dr(this,"_internalState",{relatedLogsCount:0,lokiDataSources:[]}),this._metricScene=e,this._logsConnectors=[lr(),rr(e)]}}function mr(){const e=(0,o.useStyles2)(hr);return l().createElement(o.Stack,{direction:"column",gap:2},l().createElement(o.Alert,{title:"No related logs found",severity:"info"},"We couldn't find any logs related to the current metric with your selected filters."),l().createElement(o.Text,null,"To find related logs, try the following:",l().createElement("ul",{className:e.list},l().createElement("li",null,"Adjust your label filters to include labels that exist in both the current metric and your logs"),l().createElement("li",null,"Select a metric created by a"," ",l().createElement(o.TextLink,{external:!0,href:"https://grafana.com/docs/loki/latest/alert/#recording-rules"},"Loki Recording Rule")),l().createElement("li",null,"Broaden the time range to include more data"))),l().createElement(o.Text,{variant:"bodySmall",color:"secondary"},"Note: Related logs is an experimental feature."))}function hr(e){return{list:(0,n.css)({paddingLeft:e.spacing(2),marginTop:e.spacing(1)})}}function br({context:e}){const t=(0,s.useMemo)(()=>e,[e]),{links:r,isLoading:n}=(0,a.usePluginLinks)({extensionPointId:"grafana-metricsdrilldown-app/open-in-logs-drilldown/v1",limitPerPlugin:1,context:t}),i=(0,s.useMemo)(()=>r.find(({pluginId:e})=>"grafana-lokiexplore-app"===e),[r]);if(n)return l().createElement(o.LinkButton,{variant:"secondary",size:"sm",disabled:!0},"Loading...");const u=void 0!==i;return l().createElement(o.LinkButton,{href:u?`${a.config.appSubUrl}${i.path}`:`${a.config.appSubUrl}/a/grafana-lokiexplore-app`,target:"_blank",tooltip:u?"Use the Logs Drilldown app to explore these logs":"Navigate to the Logs Drilldown app",variant:"secondary",size:"sm",onClick:()=>(0,c.z)("related_logs_action_clicked",{action:"open_logs_drilldown"})},u?"Open in Logs Drilldown":"Open Logs Drilldown")}function fr(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(e){return void r(e)}s.done?t(l):Promise.resolve(l).then(n,a)}function gr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function yr(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}),e}const vr="related_logs/logs_panel_container";class wr extends i.Bs{_onActivate(){return(e=function*(){this.state.orchestrator.addLokiDataSourcesChangeHandler(()=>this.setupLogsPanel()),this.state.orchestrator.lokiDataSources.length?this.setupLogsPanel():(this.setState({loading:!0}),yield this.state.orchestrator.findAndCheckAllDatasources(),this.setState({loading:!1}))},function(){var t=this,r=arguments;return new Promise(function(n,a){var i=e.apply(t,r);function o(e){fr(i,n,a,o,s,"next",e)}function s(e){fr(i,n,a,o,s,"throw",e)}o(void 0)})}).call(this);var e}showNoLogsFound(){i.jh.findByKeyAndType(this,vr,i.xK).setState({body:new i.dM({component:mr})}),this.setState({controls:void 0}),this.state.orchestrator.relatedLogsCount=0}_buildQueryRunner(){this._queryRunner=new i.dt({datasource:{uid:m.Kf},queries:[],key:"related_logs/logs_query"}),this._constructLogsDrilldownLinkContext(this._queryRunner.state),this._subs.add(this._queryRunner.subscribeToState(e=>{var t;if((null===(t=e.data)||void 0===t?void 0:t.state)!==G.LoadingState.Done)return;0===this.state.orchestrator.countLogsLines(e)&&this.showNoLogsFound(),this._constructLogsDrilldownLinkContext(e)}))}setupLogsPanel(){if(this._buildQueryRunner(),!this.state.orchestrator.lokiDataSources.length)return void this.showNoLogsFound();i.jh.findByKeyAndType(this,vr,i.xK).setState({body:i.d0.logs().setTitle("Logs").setData(this._queryRunner).build()});const e=new i.yP({name:m.Az,label:"Logs data source",query:this.state.orchestrator.lokiDataSources.map(e=>`${e.name} : ${e.uid}`).join(",")});this.setState({$variables:new i.Pj({variables:[e]}),controls:[new i.K8({layout:"vertical"})]}),this._subs.add(e.subscribeToState((e,t)=>{e.value!==t.value&&(0,c.z)("related_logs_action_clicked",{action:"logs_data_source_changed"})})),this.updateLokiQuery()}_constructLogsDrilldownLinkContext(e){var t,r;const n=null!==(r=null===(t=i.jh.lookupVariable(m.Az,this))||void 0===t?void 0:t.getValue())&&void 0!==r?r:"",a=e.queries,o=[];n&&a.length&&a.forEach(e=>{o.push(yr(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){gr(e,t,r[t])})}return e}({},e),{datasource:{uid:n,type:"loki"}}))}),this.setState({logsDrilldownLinkContext:{targets:o,timeRange:i.jh.getTimeRange(this).state}})}updateLokiQuery(){if(!this._queryRunner)return;const e=i.jh.lookupVariable(m.Az,this);let t;if((0,h.UG)(e)&&(t=e.getValue()),!t)return;const r=this.state.orchestrator.getLokiQueries(t);0!==r.length?this._queryRunner.setState({queries:r}):this.showNoLogsFound()}constructor(e){super({loading:!1,controls:[],body:new i.gF({templateColumns:"1fr",autoRows:"minmax(300px, 1fr)",children:[new i.xK({key:vr,body:void 0})]}),orchestrator:e.orchestrator,logsDrilldownLinkContext:{targets:[]}}),gr(this,"_queryRunner",void 0),gr(this,"_variableDependency",new i.Sh(this,{variableNames:[m.Az,m.Ao],onReferencedVariableValueChanged:e=>{e.state.name===m.Ao?this.state.orchestrator.handleFiltersChange():e.state.name===m.Az&&this.updateLokiQuery()}})),this.addActivationHandler(()=>{this._onActivate()})}}function Sr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}gr(wr,"Component",({model:e})=>{const{controls:t,body:r,logsDrilldownLinkContext:n,loading:a}=e.useState();return a?l().createElement(o.Spinner,null):l().createElement(o.Stack,{gap:1,direction:"column",grow:1},l().createElement(o.Stack,{gap:1,direction:"row",justifyContent:"space-between",alignItems:"start"},l().createElement(o.Stack,{gap:1},null==t?void 0:t.map(e=>l().createElement(e.Component,{key:e.state.key,model:e}))),l().createElement(br,{context:n})),l().createElement(r.Component,{model:r}))});class Or extends i.Bs{_onActivate(){void 0===this.state.actionView&&this.setActionView(Gt),this.relatedLogsOrchestrator.findAndCheckAllDatasources(),this.relatedLogsOrchestrator.addRelatedLogsCountChangeHandler(e=>{this.setState({relatedLogsCount:e})}),a.config.featureToggles.enableScopesInMetricsExplore&&this._subs.add(this.subscribeToEvent(m.H0,e=>{var t;null===(t=this.state.body.state.selectedTab)||void 0===t||t.publishEvent(e)}))}getUrlState(){return{actionView:this.state.actionView}}updateFromUrl(e){if("string"==typeof e.actionView){if(this.state.actionView!==e.actionView){const t=Wt.find(t=>t.value===e.actionView);t&&this.setActionView(t.value)}}else null===e.actionView&&this.setActionView(null)}setActionView(e){const{body:t}=this.state,r=e?Wt.find(t=>t.value===e):null;r&&r.value!==this.state.actionView?(t.state.topView.state.children[0].setState({maxHeight:280}),t.setState({selectedTab:r.getScene(this)}),this.setState({actionView:r.value})):(t.state.topView.state.children[0].setState({maxHeight:"40%"}),t.setState({selectedTab:void 0}),this.setState({actionView:void 0}))}createRelatedLogsScene(){return new wr({orchestrator:this.relatedLogsOrchestrator})}constructor(e){var t;const r=null!==(t=e.autoQuery)&&void 0!==t?t:Xe(e.metric,e.nativeHistogram);var n,a,o,s;super(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Sr(e,t,r[t])})}return e}({$variables:null!==(n=e.$variables)&&void 0!==n?n:(s=e.metric,new i.Pj({variables:[...(0,m.ym)(s),new b]})),body:null!==(a=e.body)&&void 0!==a?a:new Y({}),autoQuery:r,queryDef:null!==(o=e.queryDef)&&void 0!==o?o:r.main},e)),Sr(this,"relatedLogsOrchestrator",new pr(this)),Sr(this,"_urlSync",new i.So(this,{keys:["actionView"]})),Sr(this,"_variableDependency",new i.Sh(this,{variableNames:[m.Ao],onReferencedVariableValueChanged:()=>{this.relatedLogsOrchestrator.handleFiltersChange()}})),this.addActivationHandler(this._onActivate.bind(this))}}Sr(Or,"Component",({model:e})=>{const{body:t}=e.useState(),r=(0,o.useStyles2)(Er);return l().createElement("div",{className:r.container,"data-testid":"metric-scene"},l().createElement(t.Component,{model:t}))});const Er=()=>({container:(0,n.css)({position:"relative",height:"100%",width:"100%",display:"flex",flexDirection:"column"})})},9966:(e,t,r)=>{r.d(t,{s:()=>l});var n=r(7985),a=r(9585),i=r(1199),o=r(5568),s=r(3422);class l extends s.I{onActivate(){const e=n.jh.lookupVariable(o.$,this),t=n.jh.lookupVariable(a.h,this);this.setInitCounts(e,t),this._subs.add(e.subscribeToState((e,r)=>{(0,i.B)(e.options,r.options)||this.setState({counts:{current:t.state.options.length,total:e.options.length}})})),this._subs.add(t.subscribeToState((t,r)=>{t.loading||r.loading||(0,i.B)(t.options,r.options)||this.setState({counts:{current:t.options.length,total:e.state.options.length}})}))}setInitCounts(e,t){const r={current:0,total:0};!e.state.loading&&e.state.options.length&&(r.total=e.state.options.length),!t.state.loading&&t.state.options.length&&(r.current=t.state.options.length),this.setState({counts:r})}constructor(){super({key:"MetricVariableCountsProvider"}),this.addActivationHandler(this.onActivate.bind(this))}}}}]);
//# sourceMappingURL=836.js.map?_cache=5eecf79dc88bcde6048e